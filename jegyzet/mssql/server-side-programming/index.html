
<!doctype html>
<html lang="hu" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Dudás Ákos">
      
      
      <link rel="icon" href="../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>Microsoft SQL Server programozása - BMEVIAUAC01 Adatvezérelt rendszerek</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../extra-material-theme.css">
    
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="aut" data-md-color-primary="red" data-md-color-accent="red">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#microsoft-sql-server-programozasa" class="md-skip">
          Kihagyás
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Élőfej">
    <a href="../../.." title="BMEVIAUAC01 Adatvezérelt rendszerek" class="md-header__button md-logo" aria-label="BMEVIAUAC01 Adatvezérelt rendszerek" data-md-component="logo">
      
  <img src="../../../img/logo-bme-aut.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BMEVIAUAC01 Adatvezérelt rendszerek
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Microsoft SQL Server programozása
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="aut" data-md-color-primary="red" data-md-color-accent="red"  aria-label="Váltás sötét témára"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Váltás sötét témára" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent=""  aria-label="Váltás világos témára"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Váltás világos témára" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Keresés" placeholder="Keresés" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Törlés" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Keresés inicializálása
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/bmeviauac01/adatvezerelt/" title="Főoldalra ugrás" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    bmeviauac01/adatvezerelt
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Lapok" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Adatvezérelt rendszerek
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../db/" class="md-tabs__link">
        Adatbázis
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../architektura/" class="md-tabs__link md-tabs__link--active">
        Jegyzetek
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../gyakorlat/transactions/" class="md-tabs__link">
        Gyakorlatok
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../hazi/" class="md-tabs__link">
        Házi feladatok
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigáció" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="BMEVIAUAC01 Adatvezérelt rendszerek" class="md-nav__button md-logo" aria-label="BMEVIAUAC01 Adatvezérelt rendszerek" data-md-component="logo">
      
  <img src="../../../img/logo-bme-aut.png" alt="logo">

    </a>
    BMEVIAUAC01 Adatvezérelt rendszerek
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/bmeviauac01/adatvezerelt/" title="Főoldalra ugrás" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    bmeviauac01/adatvezerelt
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Adatvezérelt rendszerek
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Adatbázis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Adatbázis" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Adatbázis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../db/" class="md-nav__link">
        Minta adatbázis sémája
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../db/mssql/" class="md-nav__link">
        Microsoft SQL Server használata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../db/mongodb/" class="md-nav__link">
        MongoDB használata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://raw.githubusercontent.com/bmeviauac01/adatvezerelt/master/docs/db/mssql.sql" class="md-nav__link">
        Minta adatbázis: mssql.sql
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://raw.githubusercontent.com/bmeviauac01/adatvezerelt/master/docs/db/mongo.js" class="md-nav__link">
        Minta adatbázis: mongo.js
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Jegyzetek
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Jegyzetek" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Jegyzetek
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../architektura/" class="md-nav__link">
        Adatvezérelt rendszerek és a többrétegű (háromrétegű) architektúra
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../transactions/" class="md-nav__link">
        Tranzakciókezelés adatbázisokban
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sql/" class="md-nav__link">
        SQL nyelv, MSSQL platformfüggő SQL utasítások
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Microsoft SQL Server programozása
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Microsoft SQL Server programozása
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Tartalomjegyzék">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tartalomjegyzék
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#szerveroldali-programozas" class="md-nav__link">
    Szerveroldali programozás
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-t-sql-nyelv-alapjai" class="md-nav__link">
    A T-SQL nyelv alapjai
  </a>
  
    <nav class="md-nav" aria-label="A T-SQL nyelv alapjai">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#valtozok" class="md-nav__link">
    Változók
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utasitas-blokkok-es-vezerlesi-szerkezetek" class="md-nav__link">
    Utasítás blokkok és vezérlési szerkezetek
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#beepitett-fuggvenyek" class="md-nav__link">
    Beépített függvények
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kurzor" class="md-nav__link">
    Kurzor
  </a>
  
    <nav class="md-nav" aria-label="Kurzor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deklaracio-es-megnyitas" class="md-nav__link">
    Deklaráció és megnyitás
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leptetes" class="md-nav__link">
    Léptetés
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pelda" class="md-nav__link">
    Példa
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tarolt-eljaras-es-fuggveny" class="md-nav__link">
    Tárolt eljárás és függvény
  </a>
  
    <nav class="md-nav" aria-label="Tárolt eljárás és függvény">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#eljaras" class="md-nav__link">
    Eljárás
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skalar-fuggveny" class="md-nav__link">
    Skalár függvény
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tabla-fuggveny" class="md-nav__link">
    Tábla függvény
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hibakezeles" class="md-nav__link">
    Hibakezelés
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trigger" class="md-nav__link">
    Trigger
  </a>
  
    <nav class="md-nav" aria-label="Trigger">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dml-trigger" class="md-nav__link">
    DML trigger
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instead-of-trigger" class="md-nav__link">
    Instead of trigger
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../adonet/" class="md-nav__link">
        ADO.NET adatelérés
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linq/" class="md-nav__link">
        LINQ: Language Integrated Query
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ef/" class="md-nav__link">
        Kapcsolatok definiálása Entity Framework-ben
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongodb/" class="md-nav__link">
        MongoDB alapok, műveletek, és a MongoDB .NET Driver
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../di/" class="md-nav__link">
        Függőséginjektálás ASP.NET Core környezetben
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../async/" class="md-nav__link">
        Aszinkron kérések és DTO-k (példa WebAPI alkalmazás)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../openapi/" class="md-nav__link">
        OpenAPI 3 és a Swagger
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/bmeviauac01/rest-webapi-sample" class="md-nav__link">
        REST és WebAPI demó alkalmazás (GitHub)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/bmeviauac01/todoapi-di-sample" class="md-nav__link">
        ASP.NET Core DI demó alkalmazás (GitHub)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/bmeviauac01/threelayered-aspnetcore-sample" class="md-nav__link">
        Minta többrétegű webalkalmazás (GitHub)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Gyakorlatok
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Gyakorlatok" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Gyakorlatok
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../gyakorlat/transactions/" class="md-nav__link">
        Tranzakciókezelés
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../gyakorlat/mssql/" class="md-nav__link">
        Microsoft SQL Server programozása
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../gyakorlat/ef/" class="md-nav__link">
        Entity Framework
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../gyakorlat/mongodb/" class="md-nav__link">
        MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../gyakorlat/jpa/" class="md-nav__link">
        JPA & Spring Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../gyakorlat/rest/" class="md-nav__link">
        REST API & ASP.NET Web API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Házi feladatok
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Házi feladatok" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Házi feladatok
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../hazi/" class="md-nav__link">
        Szorgalmi házi feladatok
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../hazi/mssql/" class="md-nav__link">
        Feladat: MSSQL szerveroldali programozás
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../hazi/adonet/" class="md-nav__link">
        Feladat: ADO.NET adatelérés
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../hazi/ef/" class="md-nav__link">
        Feladat: Entity Framework
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../hazi/mongodb/" class="md-nav__link">
        Feladat: MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../hazi/rest/" class="md-nav__link">
        Feladat: REST API Web API technológiával
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../hazi/GitHub/" class="md-nav__link">
        Feladatok beadása (GitHub)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../hazi/GitHub-Actions/" class="md-nav__link">
        GitHub Actions ismertető
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../hazi/VisualStudio/" class="md-nav__link">
        Visual Studio & .NET SDK telepítése
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Tartalomjegyzék">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tartalomjegyzék
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#szerveroldali-programozas" class="md-nav__link">
    Szerveroldali programozás
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-t-sql-nyelv-alapjai" class="md-nav__link">
    A T-SQL nyelv alapjai
  </a>
  
    <nav class="md-nav" aria-label="A T-SQL nyelv alapjai">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#valtozok" class="md-nav__link">
    Változók
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utasitas-blokkok-es-vezerlesi-szerkezetek" class="md-nav__link">
    Utasítás blokkok és vezérlési szerkezetek
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#beepitett-fuggvenyek" class="md-nav__link">
    Beépített függvények
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kurzor" class="md-nav__link">
    Kurzor
  </a>
  
    <nav class="md-nav" aria-label="Kurzor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deklaracio-es-megnyitas" class="md-nav__link">
    Deklaráció és megnyitás
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#leptetes" class="md-nav__link">
    Léptetés
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pelda" class="md-nav__link">
    Példa
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tarolt-eljaras-es-fuggveny" class="md-nav__link">
    Tárolt eljárás és függvény
  </a>
  
    <nav class="md-nav" aria-label="Tárolt eljárás és függvény">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#eljaras" class="md-nav__link">
    Eljárás
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skalar-fuggveny" class="md-nav__link">
    Skalár függvény
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tabla-fuggveny" class="md-nav__link">
    Tábla függvény
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hibakezeles" class="md-nav__link">
    Hibakezelés
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#trigger" class="md-nav__link">
    Trigger
  </a>
  
    <nav class="md-nav" aria-label="Trigger">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dml-trigger" class="md-nav__link">
    DML trigger
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#instead-of-trigger" class="md-nav__link">
    Instead of trigger
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/bmeviauac01/adatvezerelt/edit/master/docs/jegyzet/mssql/server-side-programming.md" title="Oldal szerkesztése" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="microsoft-sql-server-programozasa">Microsoft SQL Server programozása<a class="headerlink" href="#microsoft-sql-server-programozasa" title="Permanent link">&para;</a></h1>
<p>A Microsoft SQL Server platform nyelve a <strong>T-SQL</strong>. A T-SQL nyelv platform specifikus, azaz a nyelv csak MSSQL szerveren használható - bár más platformoknak is meg van a saját, hasonló nyelve. A T-SQL nyelv és az általa támogatott <strong>adatbázisszerver-oldali programozási eszközök</strong> az eredetileg deklaratív SQL nyelvet imperatív eszközökkel egészítik ki, mint változók használata, elágazások, eljárások, valamint kapunk további eszközöket, mint például a triggerek és kurzorok.</p>
<h2 id="szerveroldali-programozas">Szerveroldali programozás<a class="headerlink" href="#szerveroldali-programozas" title="Permanent link">&para;</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Szerveroldali programozás</p>
<p>Szerveroldali-, avagy adatbázisszerver-oldali programozás alatt azt értjük, amikor az adatbázisban nem csupán adatot lekérdező és módosító parancsokat hajtunk végre, hanem üzleti logikai feladatokat is itt valósítunk meg.</p>
</div>
<p>Ahhoz, hogy megértsük, <em>mikor</em> érdemes szerveroldali programozási eszközöket használni, először azt érdemes megérteni, <em>miért</em> merülhet egyáltalán fel bennünk annak a lehetősége, hogy üzleti logikát az adatbázisban írjunk meg.</p>
<div class="admonition question">
<p class="admonition-title">Miért akarhatunk az adatbázisban üzleti logikai feladatokat megvalósítani?</p>
<p>A rétegzett architektúrában egy alsóbb réteg szolgáltatást nyújt a felette elhelyezkedő réteg számára. A felsőbb réteg tehát "nem tudja kikerülni" az alatta levő réteget, azon keresztül kell a feladatát elvégeznie. De ha belegondolunk, C#/Java/C++/stb. kódbázisban nem feltétlenül tudunk hasonlót garantálni. Tehát, ha egy komplex szabályrendszert és logikát megvalósítunk például egy C# osztályban, akkor nehéz azt kétséget kizáróan garantálni, hogy ezen osztályt nem lehet "megkerülni".</p>
<p>Ha azonban a logika az adatbázisban van, a logika nem, vagy sokkal kevésbé megkerülhető. Ez abból is fog fakadni, hogy a szerveroldali programozás olyan eszközöket ad a kezünkbe (lásd majd a triggereket), amelyek garantálják, hogy a logikánk minden esetben végrehajtásra kerül.</p>
</div>
<p>A szerveroldali programozásnak előnyei és hátrányai vannak. Amikor azt vizsgáljuk, egy funkciót hol célszerű megvalósítani, a rétegzett architektúra mellett azt is néznünk kell, a technológia mire ad lehetőséget, illetve a lehetséges alternatívák közül melyik jár a legtöbb előnnyel.</p>
<p>Ha üzleti logikai funkciót az adatbázisban valósítunk meg, az alábbi <strong>előnyökkel</strong> találkozhatunk.</p>
<ul>
<li>
<p>Az adatbázis konzisztenciáért való felelőssége még egyértelműbbé válik. A relációs modell nagy hangsúlyt fektet a konzisztenciára, de nem minden üzleti logikai konzisztencia feltétel írható le közvetlenül a relációs modellben. Gondoljunk csak arra a példára, hogy a Neptun rendszerben a kurzusoknak van egy létszámlimitje. Ez egy üzleti logikai szabály, amelyet, ha megszegünk, akkor az adatunk inkonzisztens üzleti értelemben. Amennyiben ezen szabály betartása is az adatbázisrendszer feladata, garantálható, hogy mindig konzisztens lesz az adat.</p>
</li>
<li>
<p>Csökkenthető az adatbázisból kifelé irányuló adatforgalom. Sokszor adatot azért kérdezünk le, hogy megjelenítsük a felhasználó számára. Nem ezen tudunk csökkenteni. De olyan esetekben, amikor csak azért kérdezünk le adatot, hogy az alapján az üzleti logika döntést hozhasson, kihagyható az adat utaztatása az adatbázis és az üzleti logika között, amennyiben a logikát visszük az adatbázisba. Ez egyben biztonságosabb is, mert nem kerül feleslegesen a hálózatra adat (ahol esetleg lehallgatható, avagy rosszul konfigurált alkalmazás miatt naplófájlokba, hibaüzenetekbe kerülhet érzékeny adat).</p>
</li>
<li>
<p>Az adatbázis szerverben megírt logika felfogható egy interfészként is, amely interfész az adat hozzáférés és módosítás részleteit elrejti a felhasználó (itt: adatelérési réteg avagy üzleti logikai réteg) elől. Ez egyrészt absztrakciót ad a kezünkbe, másrészt segítheti a párhuzamos, gyorsabb fejlesztést. Tehát, amíg egy fejlesztői csapat az adatbázisban készíti a logikát, egy másik csapat a ráépülő alkalmazást készítheti, mert az interfész, azaz, hogy az adatbázis mit és hogyan tesz elérhetővé, már korábban definiálható (az implementáció nélkül). A hibajavítás is könnyebb ilyen esetben, amennyiben a hiba az adatbázisban megírt logikában van. Ilyenkor elég egy helyen, az adatbázisban javítani a kódot, és minden ráépülő rendszer rögtön jól fog működni (ellenben azzal, ha a hibát mondjuk Java kódban kell javítani, mert akkor a Java kódbázisra épülő alkalmazásokból új verziót kell kiadni, és azt telepíteni is kell minden felhasználónál).</p>
</li>
</ul>
<p>Természetesen a szerveroldali programozásnak <strong>hátrányai</strong> is vannak.</p>
<ul>
<li>
<p>A nyelv, amit használunk platformfüggő. A megoldások nem vihetőek át egy adatbázisrendszerből másikba. Sőt, a programozói tudás se vihető át könnyen. Egy C++ programozó könnyebben tud C#-ban kódolni, mint ha nem lenne ilyen ismerete. De ez nem igaz a szerveroldali eszköztárra. Egyik platform nem ugyanazt támogatja, mint a másik. A nyelvek szintaktikája is jelentősen eltér. Az adatbázisszerver-oldali programozás egészen más eszköztárat és megközelítést, specifikus tudást igényel.</p>
</li>
<li>
<p>Az adatbázis terhelése nő. Nyilvánvaló, hogy ha több feladatot lát el egy szerver, akkor több erőforrást fog igényelni. Az adatbázisok egyébként is kritikus pontjai az adatvezérelt rendszereknek, főként, hogy a klasszikus relációs adatbázisok nem jól támogatják a horizontális skálázást (a terhelés megosztását több szerver között). Ha még több feladatot, még több felelősséget kap egy adatbázis szerver, hamar lassúvá válhat.</p>
</li>
<li>
<p>A technológia ma már nem fejlődik tovább. Nevezhetjük akár kifutó technológiának is, amelyet leginkább az ún. <em>legacy</em>, már régóta fejlesztett alkalmazásokban használnak leginkább. Új technológiai eszköztárat használó szoftverfejlesztési projektekben ritkábban jelenik meg ezen szerveroldali világ.</p>
</li>
</ul>
<h2 id="a-t-sql-nyelv-alapjai">A T-SQL nyelv alapjai<a class="headerlink" href="#a-t-sql-nyelv-alapjai" title="Permanent link">&para;</a></h2>
<p>A T-SQL nyelv tehát a Microsoft SQL Server nyelve, amely a standard SQL utasításokon felül lehetőséget ad:</p>
<ul>
<li>változók használatára,</li>
<li>elágazások és ciklusok kezelésére,</li>
<li>tárolt eljárások ("metódusok") írására,</li>
<li>kurzorok (iterátorok) használatára,</li>
<li>triggerek (eseménykezelő eljárások) definiálására,</li>
<li>és még sok minden másra is.</li>
</ul>
<p>Nézzük a nyelv szintaktikáját példákon keresztül. A pontos szintaktikát lásd a <a href="https://docs.microsoft.com/en-us/sql/t-sql/language-reference">hivatalos dokumentációban</a>.</p>
<div class="admonition note">
<p>Az alábbi példák a <a href="../../../db/">minta adatbázison</a> futtathatóak.</p>
</div>
<h3 id="valtozok">Változók<a class="headerlink" href="#valtozok" title="Permanent link">&para;</a></h3>
<p>A változókat használat előtt deklarálni kell. Konvenció szerint a változók neve <code>@</code> karakterrel kezdődik. Értékadás nélkül az inicializálatlan változó <code>NULL</code> értékű.</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">num</span> <span class="nb">int</span>

<span class="k">SELECT</span> <span class="o">@</span><span class="n">num</span>
<span class="c1">-- NULL</span>
</code></pre></div>
<p>Értékadás a <code>SET</code> utasítással lehetséges, avagy közvetlenül a deklarációban:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">num</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">SELECT</span> <span class="o">@</span><span class="n">num</span>
<span class="c1">-- 5</span>

<span class="k">SET</span> <span class="o">@</span><span class="n">num</span> <span class="o">=</span> <span class="mi">3</span>

<span class="k">SELECT</span> <span class="o">@</span><span class="n">num</span>
<span class="c1">-- 3</span>
</code></pre></div>
<p>A változó scope-ja nem kötődik az utasítás blokkhoz (<code>BEGIN-END</code> között). A változó az ún. <em>batch</em>-en belül vagy tárolt eljáráson belül érvényes:</p>
<div class="highlight"><pre><span></span><code><span class="k">BEGIN</span>
  <span class="k">DECLARE</span> <span class="o">@</span><span class="n">num</span> <span class="nb">int</span>
  <span class="k">SET</span> <span class="o">@</span><span class="n">num</span> <span class="o">=</span> <span class="mi">3</span>
<span class="k">END</span>

<span class="k">SELECT</span> <span class="o">@</span><span class="n">num</span>
<span class="c1">-- Ez működik, a változó az utasítás blokkon kívül is elérhető.</span>
<span class="c1">-- 3</span>

<span class="k">GO</span> <span class="c1">-- új batch-et kezd</span>

<span class="k">SELECT</span> <span class="o">@</span><span class="n">num</span>
<span class="c1">-- Hiba: Must declare the scalar variable &quot;@num&quot;.</span>
</code></pre></div>
<p>Változónak lekérdezéssel is adhatunk értéket:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">name</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>

<span class="k">SELECT</span> <span class="o">@</span><span class="n">name</span> <span class="o">=</span> <span class="n">Name</span>
<span class="k">FROM</span> <span class="n">Customer</span>
<span class="k">WHERE</span> <span class="n">ID</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>
<p>Ha a lekérdezés több sorral tér vissza, az <em>utolsó</em> érték marad a változóban:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">name</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>

<span class="k">SELECT</span> <span class="o">@</span><span class="n">name</span> <span class="o">=</span> <span class="n">Name</span>
<span class="k">FROM</span> <span class="n">Customer</span>
<span class="c1">-- több illeszkedő sor is lesz</span>
<span class="c1">-- SELECT utolsó eredménye kerül végül a változóba</span>
</code></pre></div>
<p>Ha a lekérdezés nem tér vissza eredménnyel, a változó értéke nem változik:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">name</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;aaa&#39;</span>

<span class="k">SELECT</span> <span class="o">@</span><span class="n">name</span> <span class="o">=</span> <span class="n">Name</span>
<span class="k">FROM</span> <span class="n">Customer</span>
<span class="k">WHERE</span> <span class="n">ID</span> <span class="o">=</span> <span class="mi">99999999</span>
<span class="c1">-- nincs illeszkedő sor</span>

<span class="k">SELECT</span> <span class="o">@</span><span class="n">name</span>
<span class="c1">-- aaa</span>
</code></pre></div>
<h3 id="utasitas-blokkok-es-vezerlesi-szerkezetek">Utasítás blokkok és vezérlési szerkezetek<a class="headerlink" href="#utasitas-blokkok-es-vezerlesi-szerkezetek" title="Permanent link">&para;</a></h3>
<p>Utasítás blokkot a <code>BEGIN-END</code> utasítás pár közé írhatunk:</p>
<div class="highlight"><pre><span></span><code><span class="k">BEGIN</span>
  <span class="k">DECLARE</span> <span class="o">@</span><span class="n">num</span> <span class="nb">int</span>
  <span class="k">SET</span> <span class="o">@</span><span class="n">num</span> <span class="o">=</span> <span class="mi">3</span>
<span class="k">END</span>
</code></pre></div>
<p>Elágazást <code>IF-ELSE</code> szerkezettel készíthetünk:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">name</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>

<span class="k">SELECT</span> <span class="o">@</span><span class="n">name</span> <span class="o">=</span> <span class="n">Name</span>
<span class="k">FROM</span> <span class="n">Customer</span>
<span class="k">WHERE</span> <span class="n">ID</span> <span class="o">=</span> <span class="mi">123</span>

<span class="k">IF</span> <span class="o">@</span><span class="n">name</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="c1">-- Ha létezik a felhasználó</span>
<span class="k">BEGIN</span>
  <span class="n">PRINT</span> <span class="s1">&#39;Updating email&#39;</span>
  <span class="k">UPDATE</span> <span class="n">Customer</span>
    <span class="k">SET</span> <span class="n">Email</span> <span class="o">=</span> <span class="s1">&#39;agh*******@gmail.com&#39;</span>
    <span class="k">WHERE</span> <span class="n">ID</span> <span class="o">=</span> <span class="mi">123</span>
<span class="k">END</span>
<span class="k">ELSE</span>
<span class="k">BEGIN</span>
  <span class="n">PRINT</span> <span class="s1">&#39;No such customer&#39;</span>
<span class="k">END</span>
</code></pre></div>
<p>Ciklushoz a <code>WHILE</code> feltételt és egy <code>BEGIN-END</code> utasításblokkot használunk:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Generáljunk legalább 1000 terméket (pl. teszteléshez)</span>
<span class="n">WHILE</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Product</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span>
<span class="k">BEGIN</span>
    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Product</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="n">Price</span><span class="p">,</span><span class="n">Stock</span><span class="p">,</span><span class="n">VATID</span><span class="p">,</span><span class="n">CategoryID</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;Abc&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
<span class="k">END</span>
</code></pre></div>
<h3 id="beepitett-fuggvenyek">Beépített függvények<a class="headerlink" href="#beepitett-fuggvenyek" title="Permanent link">&para;</a></h3>
<p>A T-SQL nyelvben számtalan <a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/functions">beépített függvény</a> érhető el. Alább pár példa a függvényekre és használatukra.</p>
<div class="admonition note">
<p>Az alábbi példákban a függvények eredményét <code>select</code>-tel lekérdezzük. Ez csupán azt a célt szolgálja, hogy láthassuk az eredményt. Függvény bárhol használható a nyelvben, ahol skalár érték használható.</p>
</div>
<p>String kezelő függvények:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Összefűzés</span>
<span class="k">SELECT</span> <span class="n">CONCAT</span> <span class="p">(</span><span class="s1">&#39;Happy &#39;</span><span class="p">,</span> <span class="s1">&#39;Birthday!&#39;</span><span class="p">)</span>
<span class="c1">-- Happy Birthday!</span>

<span class="c1">-- Bal oldalról N darab karakter</span>
<span class="k">SELECT</span> <span class="k">LEFT</span><span class="p">(</span><span class="s1">&#39;ABCDEF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">-- AB</span>

<span class="c1">-- Szöveg hossza</span>
<span class="k">SELECT</span> <span class="n">LEN</span><span class="p">(</span><span class="s1">&#39;ABCDEF&#39;</span><span class="p">)</span>
<span class="c1">-- 6</span>

<span class="c1">-- Részstring csere</span>
<span class="k">SELECT</span> <span class="k">REPLACE</span><span class="p">(</span><span class="s1">&#39;Happy Birthday!&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">)</span>
<span class="c1">-- Happy Birthmonth!</span>

<span class="c1">-- Kisbetűsre alakítás</span>
<span class="k">SELECT</span> <span class="k">LOWER</span><span class="p">(</span><span class="s1">&#39;ABCDEF&#39;</span><span class="p">)</span>
<span class="c1">-- abcdef</span>
</code></pre></div>
<p>Dátumok kezelése:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Aktuális dátum és idő</span>
<span class="k">SELECT</span> <span class="n">GETDATE</span><span class="p">()</span>
<span class="c1">-- 2021-09-28 10:43:59.120</span>

<span class="c1">-- Dátum év komponense</span>
<span class="k">SELECT</span> <span class="k">YEAR</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">())</span>
<span class="c1">-- 2021</span>

<span class="c1">-- Dátum meghatározott komponense</span>
<span class="k">SELECT</span> <span class="n">DATEPART</span> <span class="p">(</span><span class="k">day</span><span class="p">,</span><span class="s1">&#39;12/20/2021&#39;</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">DATEPART</span> <span class="p">(</span><span class="k">month</span><span class="p">,</span><span class="s1">&#39;12/20/2021&#39;</span><span class="p">)</span>
<span class="c1">-- 20</span>
<span class="c1">-- 12</span>

<span class="c1">-- Dátumok közötti különbség adott mértékegységben (itt: nap) mérve</span>
<span class="k">SELECT</span> <span class="n">DATEDIFF</span><span class="p">(</span><span class="k">day</span><span class="p">,</span> <span class="s1">&#39;2021-09-28 12:10:09&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-11-04 13:45:09&#39;</span><span class="p">)</span>
<span class="c1">-- 37</span>
</code></pre></div>
<p>Adattípus konvertálás:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span> <span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;12&#39;</span> <span class="k">as</span> <span class="nb">int</span><span class="p">)</span>
<span class="c1">-- 12</span>

<span class="k">SELECT</span> <span class="k">CONVERT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;12&#39;</span><span class="p">)</span>
<span class="c1">-- 12</span>

<span class="k">SELECT</span> <span class="k">CONVERT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span><span class="p">)</span>
<span class="c1">-- Hiba: Conversion failed when converting the varchar value &#39;aa&#39; to data type int.</span>

<span class="k">SELECT</span> <span class="n">TRY_CONVERT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span><span class="p">)</span>
<span class="c1">-- NULL</span>
</code></pre></div>
<p><code>ISNULL</code>: eredménye az első argumentum, ha az nem null, különben a második argumentum (ami lehet null is).</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span> <span class="o">@</span><span class="n">a</span> <span class="nb">int</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">b</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">SELECT</span> <span class="k">ISNULL</span><span class="p">(</span><span class="o">@</span><span class="n">a</span><span class="p">,</span> <span class="o">@</span><span class="n">b</span><span class="p">)</span>
<span class="c1">-- 5</span>
</code></pre></div>
<div class="admonition important">
<p>Nem keverendő össze az <code>is null</code> feltétellel, pl.: <code>UPDATE Product SET Price=111 WHERE Price is null</code></p>
</div>
<h2 id="kurzor">Kurzor<a class="headerlink" href="#kurzor" title="Permanent link">&para;</a></h2>
<p>A kurzor egy iterátor, amellyel egy rekord halmazon tudunk elemenként végiglépni. Akkor használjuk, amikor egy lekérdezés több elemmel tér vissza, és az elemekkel egyesével szeretnénk további feldolgozást végezni.</p>
<p>A kurzor használata több lépésből áll:</p>
<ol>
<li>A kurzort deklarálni kell, majd meg kell nyitni.</li>
<li>Az iteráció egy ciklussal történik.</li>
<li>A kurzort bezárjuk és felszabadítjuk.</li>
</ol>
<h3 id="deklaracio-es-megnyitas">Deklaráció és megnyitás<a class="headerlink" href="#deklaracio-es-megnyitas" title="Permanent link">&para;</a></h3>
<p>A deklaráció a <code>DECLARE</code> utasítással történik. Itt adjuk meg a lekérdezést is, amely az eredményeket szolgáltatja. A teljes szintaktika:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span> <span class="n">kurzornév</span> <span class="k">CURSOR</span> 
  <span class="p">[</span> <span class="n">FORWARD_ONLY</span> <span class="o">|</span> <span class="k">SCROLL</span> <span class="p">]</span> 
  <span class="p">[</span> <span class="k">STATIC</span> <span class="o">|</span> <span class="n">KEYSET</span> <span class="o">|</span> <span class="k">DYNAMIC</span> <span class="o">|</span> <span class="n">FAST_FORWARD</span> <span class="p">]</span> 
  <span class="p">[</span> <span class="n">READ_ONLY</span> <span class="o">|</span> <span class="n">SCROLL_LOCKS</span> <span class="o">|</span> <span class="n">OPTIMISTIC</span> <span class="p">]</span> 
<span class="k">FOR</span> <span class="n">lekérdezés</span> 
<span class="p">[</span> <span class="k">FOR</span> <span class="k">UPDATE</span> <span class="p">[</span> <span class="k">OF</span> <span class="n">oszlopnév</span> <span class="p">[</span> <span class="p">,...</span><span class="n">n</span> <span class="p">]</span> <span class="p">]</span> <span class="p">]</span>
</code></pre></div>
<p>A deklarációban opcionális megadható elemek jelentése (részletesebben lásd a <a href="https://docs.microsoft.com/en-us/sql/t-sql/language-elements/declare-cursor-transact-sql">dokumentációban</a>):</p>
<ul>
<li><code>FORWARD_ONLY</code>: csak <code>FETCH NEXT</code> lehetséges</li>
<li><code>SCROLL</code>: szabadon lehet előre és visszafelé is lépni a kurzorban</li>
<li><code>STATIC</code>: másolatból dolgozik, az eredmények a megnyitás (<code>OPEN</code>) időpillanatában látható tartalmat mutatja</li>
<li><code>KEYSET</code>: megnyitáskori állapot adja a sorokat és sorrendjüket, de a rekord tartalma a <code>FETCH</code> pillanatában kerül lekérdezésre</li>
<li><code>DYNAMIC</code>: minden léptetéskor aktuális állapotot adja, tehát konkurens tranzakciók módosításait is láthatjuk</li>
<li><code>READ_ONLY</code>: nem update-elhető a kurzor által léptetett tartalom</li>
<li><code>SCROLL_LOCKS</code>: léptetés zárolja a sorokat (alapból nem), ezáltal garantálva, hogy a <code>FETCH</code> utáni módosítás bizonyosan sikeres lesz</li>
<li><code>OPTIMISTIC</code>: nem zárol, optimista konkurenciakezelést alkalmaz (a <code>FETCH</code> ideje és azt követő <code>UPDATE</code> között nem történt-e módosítás)</li>
<li><code>FOR UPDATE</code>: updatelehető oszlopok listája</li>
</ul>
<p>A deklaráció még nem elég a használathoz, a kurzort meg kell nyitni az <code>OPEN</code> paranccsal. Az <code>OPEN</code> párja a kurzor használatának befejezésére a <code>CLOSE</code>. Bezárás után a kurzor újra megnyitható, így külön jelezni kell, amikor többet már nem használjuk a kurzort a <code>DEALLOCATE</code> paranccsal. (Tipikusan a <code>CLOSE</code> és <code>DEALLOCATE</code> egymást követi, mert csak egyszer használjuk a kurzort.)</p>
<h3 id="leptetes">Léptetés<a class="headerlink" href="#leptetes" title="Permanent link">&para;</a></h3>
<p>A kurzor aktuális eleméhez úgy férünk hozzá, hogy a <code>FETCH</code> utasítással "kimásoljuk" lokális változó(k)ba az értékeket. Az erre használt változókat előre deklarálni kell. A <code>FETCH</code> utasítás tipikusan a következő elemet veszi (<code>FETCH NEXT</code>), de ha nem <code>FORWARD_ONLY</code> a kurzor, akkor léphetünk előre és hátra egyet és többet is:</p>
<div class="highlight"><pre><span></span><code><span class="k">FETCH</span>   
  <span class="p">[</span> <span class="k">NEXT</span> <span class="o">|</span> <span class="k">PRIOR</span> <span class="o">|</span> <span class="k">FIRST</span> <span class="o">|</span> <span class="k">LAST</span>
      <span class="o">|</span> <span class="k">ABSOLUTE</span> <span class="err">{</span> <span class="n">n</span> <span class="o">|</span> <span class="o">@</span><span class="n">nvar</span> <span class="err">}</span>
      <span class="o">|</span> <span class="k">RELATIVE</span> <span class="err">{</span> <span class="n">n</span> <span class="o">|</span> <span class="o">@</span><span class="n">nvar</span> <span class="err">}</span>
  <span class="p">]</span>
<span class="k">FROM</span> <span class="k">cursor_name</span>
<span class="k">INTO</span> <span class="o">@</span><span class="n">variable_name</span> <span class="p">[</span> <span class="p">,...</span><span class="n">n</span> <span class="p">]</span>
</code></pre></div>
<p>Azt, hogy a <code>FETCH</code> utasítás sikeres volt-e, a <code>@@FETCH_STATUS</code> implicit változót lekérdezve tudjuk meg. A <code>@@FETCH_STATUS</code> változó értéke:</p>
<ul>
<li>0 sikeres FETCH esetén,</li>
<li>-1 sikertelen FETCH esetén,</li>
<li>-2 amennyiben a lekért sor hiányzik (<code>KEYSET</code> használatakor lehetséges).</li>
</ul>
<p>A teljes iteráció így <strong>két</strong> <code>FETCH</code> utasítást és egy <code>WHILE</code> ciklust igényel:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- declare, open ...</span>
<span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">var1</span><span class="p">,</span> <span class="o">@</span><span class="n">var2</span>
<span class="n">WHILE</span> <span class="o">@@</span><span class="n">FETCH_STATUS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">BEGIN</span>
  <span class="c1">-- .. saját logika</span>
  <span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">var1</span><span class="p">,</span> <span class="o">@</span><span class="n">var2</span>
<span class="k">END</span>
</code></pre></div>
<p>Vegyük észre, hogy a kódban kétszer szerepel a <code>FETCH</code> utasítás. Ennek oka, hogy az első, cikluson kívüli a legelső rekord lekérdezéséhez használatos, míg a második, a ciklus belsejében minden további rekordot kér le egyesével.</p>
<h3 id="pelda">Példa<a class="headerlink" href="#pelda" title="Permanent link">&para;</a></h3>
<p>Lássunk egy komplett példát. Keressük meg azon termékeket, amiből alig van raktáron, és ha a legutolsó eladás több, mint egy éve volt, akkor adjunk kedvezményt a termékre:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Ezekbe a változókba szedjük ki a kurzorból az adatokat</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">ProductName</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">ProductID</span> <span class="nb">int</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">LastOrder</span> <span class="n">datetime</span>

<span class="k">DECLARE</span> <span class="n">products_cur</span> <span class="k">CURSOR</span> <span class="k">SCROLL</span> <span class="n">SCROLL_LOCKS</span> <span class="c1">-- Zárolás hogy a módosítás garantáltan sikerüljön</span>
<span class="k">FOR</span>
  <span class="k">SELECT</span> <span class="n">Id</span><span class="p">,</span> <span class="n">Name</span> <span class="k">FROM</span> <span class="n">Product</span> <span class="k">WHERE</span> <span class="n">Stock</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="c1">-- Kurzor lekérdezése</span>
<span class="k">FOR</span> <span class="k">UPDATE</span> <span class="k">OF</span> <span class="n">Price</span> <span class="c1">-- Szeretnénk frissíteni is a rekordokat</span>

<span class="c1">-- Tipikus megnyitás, fetch, ciklus</span>
<span class="k">OPEN</span> <span class="n">products_cur</span>
<span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">products_cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">ProductID</span><span class="p">,</span> <span class="o">@</span><span class="n">ProductName</span>
<span class="n">WHILE</span> <span class="o">@@</span><span class="n">FETCH_STATUS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">BEGIN</span>

  <span class="c1">-- A ciklusban akármilyen műveletet végezhetünk</span>
  <span class="c1">-- Itt megkeressük az utolsó vásárlás idejét</span>
  <span class="k">SELECT</span> <span class="o">@</span><span class="n">LastOrder</span> <span class="o">=</span> <span class="k">MAX</span><span class="p">([</span><span class="k">Order</span><span class="p">].</span><span class="nb">Date</span><span class="p">)</span>
    <span class="k">FROM</span> <span class="p">[</span><span class="k">Order</span><span class="p">]</span> <span class="k">JOIN</span> <span class="n">OrderItem</span> <span class="k">ON</span> <span class="p">[</span><span class="k">Order</span><span class="p">].</span><span class="n">Id</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="p">.</span><span class="n">OrderId</span>
    <span class="k">WHERE</span> <span class="n">OrderItem</span><span class="p">.</span><span class="n">ProductID</span> <span class="o">=</span> <span class="o">@</span><span class="n">ProductId</span>

  <span class="c1">-- Diagnosztikai kiírás</span>
  <span class="n">PRINT</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;ProductID: &#39;</span><span class="p">,</span> <span class="k">convert</span><span class="p">(</span><span class="n">nvarchar</span><span class="p">,</span> <span class="o">@</span><span class="n">ProductID</span><span class="p">),</span> <span class="s1">&#39; Last order: &#39;</span><span class="p">,</span> <span class="k">ISNULL</span><span class="p">(</span><span class="k">convert</span><span class="p">(</span><span class="n">nvarchar</span><span class="p">,</span> <span class="o">@</span><span class="n">LastOrder</span><span class="p">),</span> <span class="s1">&#39;No last order&#39;</span><span class="p">))</span>

  <span class="k">IF</span> <span class="o">@</span><span class="n">LastOrder</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">OR</span> <span class="o">@</span><span class="n">LastOrder</span> <span class="o">&lt;</span> <span class="n">DATEADD</span><span class="p">(</span><span class="k">year</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">GETDATE</span><span class="p">())</span>
  <span class="k">BEGIN</span>
    <span class="k">UPDATE</span> <span class="n">Product</span>
      <span class="k">SET</span> <span class="n">Price</span> <span class="o">=</span> <span class="n">Price</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">75</span>
      <span class="k">WHERE</span> <span class="k">CURRENT</span> <span class="k">OF</span> <span class="n">products_cur</span>
      <span class="c1">-- Aktuális kurzor rekord frissítése</span>
      <span class="c1">-- Alternatíva: WHERE Id = @ProductID</span>
  <span class="k">END</span>

  <span class="c1">-- Következő rekord lekérdezése, majd ugrás a WHILE ciklushoz ellenőrizve, hogy sikeres volt-e</span>
  <span class="k">FETCH</span> <span class="k">NEXT</span> <span class="k">FROM</span> <span class="n">products_cur</span> <span class="k">INTO</span> <span class="o">@</span><span class="n">ProductID</span><span class="p">,</span> <span class="o">@</span><span class="n">ProductName</span>
<span class="k">END</span>
<span class="c1">-- Kurzor használatának befejezése</span>
<span class="k">CLOSE</span> <span class="n">products_cur</span>
<span class="k">DEALLOCATE</span> <span class="n">products_cur</span>
</code></pre></div>
<h2 id="tarolt-eljaras-es-fuggveny">Tárolt eljárás és függvény<a class="headerlink" href="#tarolt-eljaras-es-fuggveny" title="Permanent link">&para;</a></h2>
<p>A korábbi példákban megírt kódokat a megírásuk után beküldtük a szervernek, amely azonnal végrehajtotta őket. Lehetőségünk van olyan kódot is írni, amelyet a szerver eltárol és később bármikor meghívhatjuk. Egy moduláris programozási környezetben függvényeknek, objektumorientált világban pedig metódusoknak szoktuk ezt hívni. Microsoft SQL Server esetében ezeket tárolt eljárásnak és tárolt függvénynek hívjuk. A névben a <em>tárolt</em> arra utal, hogy az eljárás kódját az adatbázis eltárolja, így az adat mellett része lesz az adatbázisnak (és például a biztonsági mentésbe is bekerül).</p>
<p>Az <em>eljárás</em> és a <em>függvény</em> között annyi a különbség, hogy az eljárásoknak tipikusan nincs visszatérési értéke, míg a függvényeknek van. További megkötés MSSQL platformon, hogy a függvények csak olvashatják az adatbázist, de módosítást nem végezhetnek.</p>
<h3 id="eljaras">Eljárás<a class="headerlink" href="#eljaras" title="Permanent link">&para;</a></h3>
<p>Egy tárolt eljárást az alábbi szintaktikával hozhatunk létre:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span> <span class="p">[</span><span class="k">OR</span> <span class="k">ALTER</span><span class="p">]</span> <span class="n">PROC</span><span class="p">[</span><span class="n">EDURE</span><span class="p">]</span> <span class="n">eljárás_név</span> 
  <span class="p">[</span> <span class="err">{</span> <span class="o">@</span><span class="n">paraméter</span> <span class="n">adattípus</span> <span class="err">}</span> <span class="p">]</span> <span class="p">[</span> <span class="p">,...</span><span class="n">n</span> <span class="p">]</span> 
<span class="k">AS</span>
<span class="p">[</span><span class="k">BEGIN</span><span class="p">]</span>
  <span class="n">sql_utasítások</span> <span class="p">[</span> <span class="p">...</span><span class="n">n</span> <span class="p">]</span> 
<span class="p">[</span><span class="k">END</span><span class="p">]</span>
</code></pre></div>
<p>A <code>CREATE OR ALTER</code> eredménye a tárolt eljárás létrehozása, ha nem létezett, avagy ha már létezett ilyen névvel, akkor annak frissítése az új tartalommal. MSSQL Server 2016 előtt nem volt <code>CREATE OR ALTER</code>, csak <code>CREATE PROC</code> és <code>ALTER PROC</code>. Egy tárolt eljárást a <code>DROP PROCEDURE</code> utasítással lehet törölni, melynek hatására az eljárás eltávolításra kerül a szerverből és többet nem hívható meg.</p>
<p>Lássuk például az ÁFA kulcs rögzítését a <code>VAT</code> táblába annak garantálásával, hogy olyan kulcs nem rögzíthető mely már létezik:</p>
<div class="highlight"><pre><span></span><code><span class="k">create</span> <span class="k">or</span> <span class="k">alter</span> <span class="k">procedure</span> <span class="n">InsertNewVAT</span> <span class="c1">-- tárolt eljárás létrehozása, neve</span>
    <span class="o">@</span><span class="n">Percentage</span> <span class="nb">int</span>                    <span class="c1">-- tárolt eljárás paraméterei</span>
<span class="k">as</span>
  <span class="k">begin</span>
  <span class="c1">-- innen kezdődik a kód, amit az eljárás meghívásakor végrehajt a rendszer</span>
  <span class="k">begin</span> <span class="n">tran</span>                            <span class="c1">-- nem megismételhető olvasás elkerülése végett</span>
  <span class="k">set</span> <span class="k">transaction</span> <span class="k">isolation</span> <span class="k">level</span> <span class="k">repeatable</span> <span class="k">read</span>

  <span class="k">declare</span> <span class="o">@</span><span class="k">Count</span> <span class="nb">int</span>

  <span class="k">select</span> <span class="o">@</span><span class="k">Count</span> <span class="o">=</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
  <span class="k">from</span> <span class="n">VAT</span>
  <span class="k">where</span> <span class="n">Percentage</span> <span class="o">=</span> <span class="o">@</span><span class="n">Percentage</span>

  <span class="k">if</span> <span class="o">@</span><span class="k">Count</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">insert</span> <span class="k">into</span> <span class="n">VAT</span> <span class="k">values</span> <span class="p">(</span><span class="o">@</span><span class="n">Percentage</span><span class="p">)</span>
  <span class="k">else</span>
      <span class="n">print</span> <span class="s1">&#39;error&#39;</span><span class="p">;</span>

<span class="k">commit</span>
<span class="k">end</span>
</code></pre></div>
<p>Tárolt eljárás az előbbi parancs hatására létrejön, és utána az alábbi módon hívhatjuk meg:</p>
<div class="highlight"><pre><span></span><code><span class="k">exec</span> <span class="n">InsertNewVAT</span> <span class="mi">27</span>
</code></pre></div>
<p>A tárolt eljárások az adatbázisunk részei. Microsoft SQL Server Management Studio-ban például a képen látható helyen jelennek meg:</p>
<p><img alt="Tárolt eljárás az adatbázisban" src="../img/mssql-stored-proc-in-db.png" /></p>
<h3 id="skalar-fuggveny">Skalár függvény<a class="headerlink" href="#skalar-fuggveny" title="Permanent link">&para;</a></h3>
<p>Függvény deklarációja az eljáráséhoz hasonlóan történik, azonban meg kell adni a visszatérési típust is:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span> <span class="p">[</span> <span class="k">OR</span> <span class="k">ALTER</span> <span class="p">]</span> <span class="k">FUNCTION</span> <span class="n">név</span>
<span class="p">(</span> <span class="p">[</span> <span class="err">{</span> <span class="o">@</span><span class="n">paraméter</span> <span class="n">adattípus</span> <span class="err">}</span> <span class="p">]</span> <span class="p">[</span> <span class="p">,...</span><span class="n">n</span> <span class="p">]</span> <span class="p">)</span>
<span class="k">RETURNS</span> <span class="n">adattípus</span>
<span class="p">[</span> <span class="k">AS</span> <span class="p">]</span>
<span class="k">BEGIN</span>
  <span class="n">utasítások</span>
  <span class="k">RETURN</span> <span class="n">skalár_érték</span>
<span class="k">END</span>
</code></pre></div>
<p>Nézzük egy <code>int</code> visszatérési értékű függvényt amelynek nincs bemenő paramétere:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">ALTER</span> <span class="k">FUNCTION</span> <span class="n">LargestVATPercentage</span><span class="p">()</span>
<span class="k">RETURNS</span> <span class="nb">int</span>
<span class="k">BEGIN</span>
<span class="k">RETURN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">MAX</span><span class="p">(</span><span class="n">Percentage</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">VAT</span><span class="p">)</span>
<span class="k">END</span>
</code></pre></div>
<p>Ezt a függvényt így használhatjuk:</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span> <span class="n">dbo</span><span class="p">.</span><span class="n">LargestVATPercentage</span><span class="p">()</span>
<span class="c1">-- A dbo előtag a séma azonosítása, amivel azt jelöljük, hogy ez nem egy beépített függvény</span>
<span class="c1">-- Enélkül a függvényt nem találja meg a rendszer</span>

<span class="c1">-- avagy például</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">maxvat</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">dbo</span><span class="p">.</span><span class="n">LargestVATPercentage</span><span class="p">()</span>
<span class="k">select</span> <span class="o">@</span><span class="n">maxvat</span>
</code></pre></div>
<h3 id="tabla-fuggveny">Tábla függvény<a class="headerlink" href="#tabla-fuggveny" title="Permanent link">&para;</a></h3>
<p>Nem csak skalár értékkel térhet vissza egy függvény, az eredmény lehet tábla típusú is. Ilyenkor a deklaráció így néz ki:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span> <span class="p">[</span> <span class="k">OR</span> <span class="k">ALTER</span> <span class="p">]</span> <span class="k">FUNCTION</span> <span class="n">név</span>
<span class="p">(</span> <span class="p">[</span> <span class="err">{</span> <span class="o">@</span><span class="n">paraméter</span> <span class="n">adattípus</span> <span class="err">}</span> <span class="p">]</span> <span class="p">[</span> <span class="p">,...</span><span class="n">n</span> <span class="p">]</span> <span class="p">)</span>
<span class="k">RETURNS</span> <span class="k">TABLE</span>
<span class="p">[</span> <span class="k">AS</span> <span class="p">]</span>
<span class="k">RETURN</span> <span class="k">select</span> <span class="n">utasítás</span>
</code></pre></div>
<p>Nézzük például az áfakulcsok lekérését egy adott százalék felett:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">VATPercentages</span><span class="p">(</span><span class="o">@</span><span class="k">min</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">RETURNS</span> <span class="k">TABLE</span>
<span class="k">AS</span> <span class="k">RETURN</span>
<span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">ID</span><span class="p">,</span> <span class="n">Percentage</span> <span class="k">FROM</span> <span class="n">VAT</span>
    <span class="k">WHERE</span> <span class="n">Percentage</span> <span class="o">&gt;</span> <span class="o">@</span><span class="k">min</span>
<span class="p">)</span>
</code></pre></div>
<p>Ezen függvény táblát ad vissza, tehát bárhol használhatjuk a függvényt, ahol tábla állhat, például:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">VATPercentages</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div>
<p>Mivel a függvény táblát ad vissza, akár <code>join</code>-olhatunk is rá:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span> <span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">VAT</span> <span class="k">JOIN</span> <span class="n">VATPercentages</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="n">p</span> <span class="k">on</span> <span class="n">VAT</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">Id</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span>
</code></pre></div>
<h2 id="hibakezeles">Hibakezelés<a class="headerlink" href="#hibakezeles" title="Permanent link">&para;</a></h2>
<p>A tárolt eljárást ismertető példában meg akartuk akadályozni a duplikált rekord beszúrását egy táblába. Ezt fentebb úgy értük el, hogy nem hajtottuk végre az utasítást. Azonban célszerűbb lenne jelezni a hibát a hívó számára. Erre szolgál a strukturált hibajelzés és kezelés. Hiba esetén a <code>throw</code> paranccsal dobhatunk hibát. Ezen parancs hatására a kód végrehajtása megszakad és a hívóhoz visszakerül a végrehajtás (ahol a hiba lekezelhető, avagy továbbdobható). A hibának van egy hibaszáma (50000 és 2147483647 között), egy szövege, és egy 0-255 közötti hiba állapot azonosító.</p>
<p>Ezzel a kiegészítve az ÁFA kulcs rögzítése az ÁFA táblába tárolt eljárásunk így néz ki:</p>
<div class="highlight"><pre><span></span><code><span class="k">create</span> <span class="k">or</span> <span class="k">alter</span> <span class="k">procedure</span> <span class="n">InsertNewVAT</span>
    <span class="o">@</span><span class="n">Percentage</span> <span class="nb">int</span>
<span class="k">as</span>
<span class="k">begin</span>

  <span class="k">begin</span> <span class="n">tran</span>
  <span class="k">set</span> <span class="k">transaction</span> <span class="k">isolation</span> <span class="k">level</span> <span class="k">repeatable</span> <span class="k">read</span>

  <span class="k">declare</span> <span class="o">@</span><span class="k">Count</span> <span class="nb">int</span>

  <span class="k">select</span> <span class="o">@</span><span class="k">Count</span> <span class="o">=</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
  <span class="k">from</span> <span class="n">VAT</span>
  <span class="k">where</span> <span class="n">Percentage</span> <span class="o">=</span> <span class="o">@</span><span class="n">Percentage</span>

  <span class="k">if</span> <span class="o">@</span><span class="k">Count</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">insert</span> <span class="k">into</span> <span class="n">VAT</span> <span class="k">values</span> <span class="p">(</span><span class="o">@</span><span class="n">Percentage</span><span class="p">)</span>
  <span class="k">else</span>
<span class="hll">      <span class="n">throw</span> <span class="mi">51000</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span>
</span>
  <span class="k">commit</span>
<span class="k">end</span>
</code></pre></div>
<p>Hiba lekezelése (elkapására) az alábbi szintaktikát használhatjuk:</p>
<div class="highlight"><pre><span></span><code><span class="k">begin</span> <span class="n">try</span>
  <span class="k">exec</span> <span class="n">InsertNewVAT</span> <span class="mi">27</span>
<span class="k">end</span> <span class="n">try</span>
<span class="k">begin</span> <span class="n">catch</span>
  <span class="c1">-- az alábbi függvényekkel hozzáférünk a hiba részleteihez (hasonlóan, mint a stack trace más nyelvekben)</span>
  <span class="k">SELECT</span>
    <span class="n">ERROR_NUMBER</span><span class="p">()</span> <span class="k">AS</span> <span class="n">ErrorNumber</span><span class="p">,</span>
    <span class="n">ERROR_SEVERITY</span><span class="p">()</span> <span class="k">AS</span> <span class="n">ErrorSeverity</span><span class="p">,</span>
    <span class="n">ERROR_STATE</span><span class="p">()</span> <span class="k">AS</span> <span class="n">ErrorState</span><span class="p">,</span>
    <span class="n">ERROR_PROCEDURE</span><span class="p">()</span> <span class="k">AS</span> <span class="n">ErrorProcedure</span><span class="p">,</span>
    <span class="n">ERROR_LINE</span><span class="p">()</span> <span class="k">AS</span> <span class="n">ErrorLine</span><span class="p">,</span>
    <span class="n">ERROR_MESSAGE</span><span class="p">()</span> <span class="k">AS</span> <span class="n">ErrorMessage</span><span class="p">;</span>
<span class="k">end</span> <span class="n">catch</span>
</code></pre></div>
<p>Hibát természetesen nem csak mi dobhatunk. A rendszer is analóg módon jelez hibákat, amelyeket ugyanezen eszközökkel kezelhetünk.</p>
<h2 id="trigger">Trigger<a class="headerlink" href="#trigger" title="Permanent link">&para;</a></h2>
<p>Az eddig ismertetett eszközök és nyelvi elemek hasonlók más platformokon elérhető lehetőségekhez. A triggerek azonban speciális eszközök, amelyekhez hasonlót máshol nem igen találunk. A triggerek eseménykezelő tárolt eljárások. Használatukkal az adatbázisban történő különböző eseményekre tudunk feliratkozni és az esemény bekövetkeztekor a rendszer a triggerben megadott kódunkat lefuttatja.</p>
<p>Az alábbiakban kifejezetten DML triggerekkel foglalkozunk. Ezek az adatmódosítás (<code>insert</code>, <code>update</code>, <code>delete</code>) műveletek hatására lefutó triggerek. Léteznek más triggerek is, akár rendszereseményekre is lehet triggert készíteni, ezekkel kapcsolatban lásd a <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-trigger-transact-sql">hivatalos dokumentációt</a>.</p>
<h3 id="dml-trigger">DML trigger<a class="headerlink" href="#dml-trigger" title="Permanent link">&para;</a></h3>
<p>Triggerek használatával több olyan feladatot is meg tudunk oldani, amely nélkülük nehéz lenne. Gondoljunk például egy <strong>audit naplózási</strong> feladatra: amikor egy adott táblában valamilyen módosítás történik, arról rögzítsünk egy rekordot egy napló táblába. Ezt a feladatot C#/Java/Python kódban is meg tudnánk oldani, csakhogy az érintett tábla tartalommódosítását így becsomagoló osztály vagy kódrészlet megkerülhető - semmi nem akadályozza meg a programozót abban, hogy "kikerülje" az így megírt logikát és az adatbázist direktben érje el. Ezt megakadályozni triggerekkel se tudjuk, azonban készíthetünk egy triggert, amely C#/Java/Python kód helyett elvégzi a szükséges naplózást.</p>
<p>Nézzük is ennek a példának a kódját. Naplózzuk tehát bármely termékek törlését egy napló táblába:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Napló tábla létrehozása</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">AuditLog</span><span class="p">([</span><span class="n">Description</span><span class="p">]</span> <span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="k">max</span><span class="p">)</span> <span class="k">NULL</span><span class="p">)</span>
<span class="k">go</span>

<span class="c1">-- Naplózó trigger</span>
<span class="k">create</span> <span class="k">or</span> <span class="k">alter</span> <span class="k">trigger</span> <span class="n">ProductDeleteLog</span>
  <span class="k">on</span> <span class="n">Product</span>
  <span class="k">for</span> <span class="k">delete</span>
<span class="k">as</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">AuditLog</span><span class="p">(</span><span class="n">Description</span><span class="p">)</span>
<span class="k">select</span> <span class="s1">&#39;Product deleted: &#39;</span> <span class="o">+</span> <span class="k">convert</span><span class="p">(</span><span class="n">nvarchar</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span> <span class="k">from</span> <span class="n">deleted</span> <span class="n">d</span>
</code></pre></div>
<p>A fenti parancsok lefuttatásának hatására létrejön a trigger az adatbázisban (mint ahogy egy tárolt eljárás is létrejön), és a rendszer ezt a triggert minden érintett eseménynél lefuttatja. Tehát a triggert nem mi futtatjuk, hanem a rendszer. Ennek ellenére adunk nevet a triggernek, hogy hivatkozhassunk rá (pl., ha törölni akarjuk a <code>DROP TRIGGER</code> utasítással). A trigger az érintett táblához kötve látható az adatbázisban:</p>
<p><img alt="Trigger az adatbázisban" src="../img/mssql-trigger-in-db.png" /></p>
<p>Egy DML trigger definiálásának szintaktikája az alábbi:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">trigger_név</span>
<span class="k">ON</span> <span class="err">{</span> <span class="n">tábla</span> <span class="o">|</span> <span class="n">nézet</span> <span class="err">}</span>
 <span class="k">FOR</span>  <span class="err">{</span> <span class="p">[</span> <span class="k">DELETE</span> <span class="p">]</span> <span class="p">[</span> <span class="p">,</span> <span class="p">]</span> <span class="p">[</span> <span class="k">INSERT</span> <span class="p">]</span> <span class="p">[</span> <span class="p">,</span> <span class="p">]</span> <span class="p">[</span> <span class="k">UPDATE</span> <span class="p">]</span> <span class="err">}</span>
<span class="k">AS</span> 
<span class="n">sql_utasítás</span> <span class="p">[</span> <span class="p">...</span><span class="n">n</span> <span class="p">]</span>
</code></pre></div>
<p>Lássuk, hogy a trigger definiálásakor megadjuk a táblát avagy nézetet, amelyre a triggert definiáljuk. Egy trigger tehát egyetlen tábla eseményeire figyel. Azt, hogy milyen esemény, azt pedig úgy adjuk meg, hogy felsoroljuk a módosító eseményeket (pl. <code>for update, insert</code>). Vegyük észre, hogy a három lehetőség mindenféle módosítást lefed, és hogy <code>select</code> jellegű esemény nincs - hiszen az nem módosítás.</p>
<p>A trigger kódjában definiált utasításokat a rendszer az érintett tábla specifikált eseményei <em>után</em> hajtja végre. Ez azt jelenti, hogy a módosításokat a rendszer elvégezte (például beszúrás esetén már szerepelnek az új sorok a táblában), azonban még a tranzakciót nem zárta le. Így tehát lehetőségünk van további módosításokat végezni a tranzakció részeként (és így egyben, atominak látva az "eredeti" utasítás és a trigger eredményét is), vagy akár megszakítani a tranzakciót. A triggerek egy speciális használati esete a (máshogy nem leírható) konzisztencia ellenőrzése és hiba esetén a módosítás megszakítása. Hamarosan látunk erre is példát.</p>
<p>A triggerek <em>utasítás szintűek</em>, ami azt jelenti, hogy DML utasításonként egyszer hívódnak meg. A trigger nem egyetlen rekord változását kezeli le, hanem egyetlen utasítás összes módosítását. Tehát ha például egy <code>update</code> utasítás 15 sort módosít, akkor a trigger egyetlen alkalommal kerül meghívásra és abban az egyetlen alkalomban mind a 15 módosítást egyszerre látja. Ez természetesen igaz a beszúrásra és törlésre is - egy törlés művelet törölhet egyszerre több sort, és beszúrni is lehet egyetlen utasítással több rekordot.</p>
<div class="admonition warning">
<p class="admonition-title">Nincs sor szintű trigger</p>
<p>Más adatbázis platformon létezik <em>sor szintű trigger</em>, ahol is a módosított sorokra egyenként hívódik meg a trigger. Microsoft SQL Server platformon ilyen nem létezik!</p>
</div>
<p>Honnan tudjuk meg a triggerben milyen módosítás történt? A trigger kódjában hozzáférünk két napló táblához az <code>inserted</code> és <code>deleted</code> implicit változókon keresztül. Ezen táblák szerkezete megegyezik annak a táblának a szerkezetével, amelyre a triggert definiáltuk. A táblák csak a trigger lefutása alatt léteznek és csak a triggerből érhetőek el. A tartalmuk attól függ, hogy milyen jellegű utasítás indította a triggert:</p>
<table>
<thead>
<tr>
<th></th>
<th>insert</th>
<th>delete</th>
<th>update</th>
</tr>
</thead>
<tbody>
<tr>
<td>inserted</td>
<td>új rekordok</td>
<td>üres</td>
<td>rekordok új értékei</td>
</tr>
<tr>
<td>deleted</td>
<td>üres</td>
<td>törölt rekordok</td>
<td>rekordok régi értékei</td>
</tr>
</tbody>
</table>
<p>Beszúrás esetén tehát a beszúrt rekordok a táblában is megtalálhatóak (de ott nem "látjuk", hogy újonnan kerültek beszúrásra), és emellett az <code>inserted</code> táblában érhetőek el. Törlés esetén analóg módon a <code>deleted</code> táblában van a törlés előtti állapotuk, de a táblából már törölve vannak. Végezetül <code>update</code> esetén a módosítás előtti és utáni állapotokat látjuk a két naplótáblában. Ezen napló táblákkal tábla módjára kell dolgozni, tehát mindig arra kell számítanunk, hogy több rekord van bennük.</p>
<div class="admonition warning">
<p class="admonition-title">Az <code>inserted</code> és <code>deleted</code> táblák</p>
<p>Az <code>inserted</code> és <code>deleted</code> tábla, csak táblaként kezelhetjük! Tehát nem használhatjuk mondjuk így: <code>select @id=inserted.ID</code>, viszont használhatjuk kurzorban vagy <code>join</code>-ban is ezen táblákat.</p>
</div>
<p>Láttunk már egy példát triggerrel megvalósított audit naplózásra. Nézzük más jellegű felhasználását. Legyen adott egy tábla egy email cím oszloppal. Ellenőrizzük beszúrásnál és módosításnál az email cím értéket és ne engedjünk biztosan nem email címnek kinéző szöveget beszúrni. Itt tehát <strong>máshogy nem leírható konzisztencia szabályt</strong> tartunk be a triggerrel.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Az email cím ellenőrzéshez készítsünk egy függvényt</span>
<span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="p">[</span><span class="n">IsEmailValid</span><span class="p">](</span><span class="o">@</span><span class="n">email</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>   
<span class="k">RETURNS</span> <span class="nb">bit</span> <span class="c1">-- true/false visszatérési érték</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
  <span class="k">IF</span> <span class="o">@</span><span class="n">email</span> <span class="k">is</span> <span class="k">null</span> <span class="k">RETURN</span> <span class="mi">0</span> <span class="c1">-- Nem lehet null</span>
  <span class="k">IF</span> <span class="o">@</span><span class="n">email</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">RETURN</span> <span class="mi">0</span> <span class="c1">-- Nem lehet üres string</span>
  <span class="k">IF</span> <span class="o">@</span><span class="n">email</span> <span class="k">LIKE</span> <span class="s1">&#39;%_@%_._%&#39;</span> <span class="k">RETURN</span> <span class="mi">1</span> <span class="c1">-- Kb. email kinézete van</span>
  <span class="k">RETURN</span> <span class="mi">0</span>
  <span class="c1">-- Ugyanez rövidebben a CASE szerkezettel:</span>
  <span class="c1">-- RETURN CASE WHEN ISNULL(@email, &#39;&#39;) &lt;&gt; &#39;&#39; AND @email LIKE &#39;%_@%_._%&#39; THEN 1 ELSE 0 END</span>
<span class="k">END</span>

<span class="c1">-- Definiáljuk a triggert</span>
<span class="k">create</span> <span class="k">or</span> <span class="k">alter</span> <span class="k">trigger</span> <span class="n">CustomerEmailSyntaxCheck</span>
  <span class="k">on</span> <span class="n">Customer</span>
  <span class="k">for</span> <span class="k">insert</span><span class="p">,</span> <span class="k">update</span> <span class="c1">-- beszúrás és módosítás is érdekel</span>
<span class="k">as</span>
<span class="c1">-- Mind a beszúrás mind módosítás esetén az inserted táblában lesz az új adat</span>
<span class="c1">-- Létezik-e olyan elem ott, amire az új email cím nem érvényes</span>
<span class="k">if</span> <span class="k">exists</span><span class="p">(</span><span class="k">select</span> <span class="mi">1</span> <span class="k">from</span> <span class="n">inserted</span> <span class="n">i</span> <span class="k">where</span> <span class="n">dbo</span><span class="p">.</span><span class="n">IsEmailValid</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">Email</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">throw</span> <span class="mi">51234</span><span class="p">,</span> <span class="s1">&#39;invalid email address&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="c1">-- szakítsuk meg a tranzakciót a hiba eldobásával</span>
</code></pre></div>
<p>A fenti trigger ugyan a beszúrás avagy módosítás után fut, de még ugyanabban a tranzakcióban. Tehát ha hibát dobunk, akkor a tranzakció meg fog szakadni (hacsak nem kezeli le a hívó). Azzal, hogy a trigger utasítás szinten fut, egyetlen hibás sor is az egész utasítást szakítja meg - természetesen ezt várjuk az atomiság miatt: az utasítás egészére, azaz több sor beszúrására/módosítására egyszerre teljesül az oszthatatlanság.</p>
<p>Triggerek további gyakori felhasználási esete a <strong>denormalizált adat karbantartása</strong>. Ugyan egy relációs adatbázisban igyekszünk elkerülni a denormalizálást, a gyakorlatban teljesítmény okokból lehet mégis szükség számított adat külön eltárolására. Nézzünk egy példát erre is. Tegyük fel, hogy a vevőknek két email címe is van: egy a bejelentkezéshez, és megadhatnak egy másikat, amit az értesítésekhez használni akarnak. Hogy ne kelljen mindig mindkét email címet minden alkalommal lekérdezni, és választani a kettő közül, legyen elérhető adatbázisban a valóban használt email cím, amely az előző kettőből "számítható":</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Plusz email cím oszlopok a vevőknek</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">Customer</span>
<span class="k">add</span> <span class="p">[</span><span class="n">NotificationEmail</span><span class="p">]</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">),</span> <span class="p">[</span><span class="n">EffectiveEmail</span><span class="p">]</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
<span class="k">go</span>

<span class="c1">-- Használt email címet frissítő trigger</span>
<span class="k">create</span> <span class="k">or</span> <span class="k">alter</span> <span class="k">trigger</span> <span class="n">CustomerEmailUpdate</span>
  <span class="k">on</span> <span class="n">Customer</span>
  <span class="k">for</span> <span class="k">insert</span><span class="p">,</span> <span class="k">update</span>
<span class="k">as</span>
<span class="k">update</span> <span class="n">Customer</span> <span class="c1">-- A Customer táblát módosítjuk, nem az inserted-et</span>
<span class="k">set</span> <span class="n">EffectiveEmail</span> <span class="o">=</span> <span class="k">ISNULL</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">NotificationEmail</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">Email</span><span class="p">)</span> <span class="c1">-- Egyik vagy másik értéket másolja az EffectiveEmail oszlopba</span>
<span class="k">from</span> <span class="n">Customer</span> <span class="k">c</span> <span class="k">join</span> <span class="n">inserted</span> <span class="n">i</span> <span class="k">on</span> <span class="k">c</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">ID</span> <span class="c1">-- Az inserted-ek alapján kell a Customer-ben kikeresni a rekordokat</span>
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Trigger rekurzió</p>
<p>Vegyük észre az előbbi triggerben, hogy a módosítás reagálásaként egy újabb módosítást hajtunk végre. Ez tehát rekurzió. A DML triggerek rekurziója alapesetben ki van kapcsolva, így a fenti példa nem vált ki rekurziót. Amennyiben viszont engedélyezett az adatbázisban a trigger rekurzió, azt kezelnünk is kell.</p>
</div>
<p>Nézzünk egy másik denormalizált adat karbantartás példát. A megrendelés táblába vegyünk fel egy végösszeg oszlopot, amely a megrendelés teljes nettó ára, és ezt automatikusan tartsuk karban:</p>
<div class="highlight"><pre><span></span><code><span class="k">create</span> <span class="k">or</span> <span class="k">alter</span> <span class="k">trigger</span> <span class="n">OrderTotalUpdateTrigger</span>
  <span class="k">on</span> <span class="n">OrderItem</span>
  <span class="k">for</span> <span class="k">insert</span><span class="p">,</span> <span class="k">update</span><span class="p">,</span> <span class="k">delete</span>
<span class="k">as</span>

<span class="k">update</span> <span class="k">Order</span>
<span class="k">set</span> <span class="n">Total</span> <span class="o">=</span> <span class="k">isnull</span><span class="p">(</span><span class="n">Total</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">TotalChange</span>
<span class="k">from</span> <span class="k">Order</span> <span class="k">inner</span> <span class="k">join</span>
        <span class="p">(</span><span class="k">select</span> <span class="n">i</span><span class="p">.</span><span class="n">OrderID</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">Amount</span><span class="o">*</span><span class="n">Price</span><span class="p">)</span> <span class="k">as</span> <span class="n">TotalChange</span>
        <span class="k">from</span> <span class="n">inserted</span> <span class="n">i</span>
        <span class="k">group</span> <span class="k">by</span> <span class="n">i</span><span class="p">.</span><span class="n">OrderID</span><span class="p">)</span> <span class="n">OrderChange</span>
    <span class="k">on</span> <span class="k">Order</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">OrderChange</span><span class="p">.</span><span class="n">OrderID</span>

<span class="k">update</span> <span class="k">Order</span>
<span class="k">set</span> <span class="n">Total</span> <span class="o">=</span> <span class="k">isnull</span><span class="p">(</span><span class="n">Total</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="err">–</span> <span class="n">TotalChange</span>
<span class="k">from</span> <span class="k">Order</span> <span class="k">inner</span> <span class="k">join</span>
        <span class="p">(</span><span class="k">select</span> <span class="n">d</span><span class="p">.</span><span class="n">OrderID</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">Amount</span><span class="o">*</span><span class="n">Price</span><span class="p">)</span> <span class="k">as</span> <span class="n">TotalChange</span>
        <span class="k">from</span> <span class="n">deleted</span> <span class="n">d</span>
        <span class="k">group</span> <span class="k">by</span> <span class="n">d</span><span class="p">.</span><span class="n">OrderID</span><span class="p">)</span> <span class="n">OrderChange</span>
    <span class="k">on</span> <span class="k">Order</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">OrderChange</span><span class="p">.</span><span class="n">OrderID</span>
</code></pre></div>
<p>Ebben a triggerben érdemes észrevenni, hogy míg az esemény az <code>OrderItem</code> táblában történik, a frissítendő tartalom az <code>Order</code> táblában van. Ez abszolút működőképes, egy trigger az adatbázis bármely részét olvashatja és írhatja, és továbbra is minden módosítás ugyanabban a tranzakcióban fut. Továbbá érdemes megérteni, hogy a triggerben nem újraszámoljuk az összeget, hanem kijavítjuk azt a változásokkal. Ez természetesen komplexebbé teszi a trigger kódját, de így lesz hatékony.</p>
<div class="admonition note">
<p class="admonition-title">Triggerek sorrendje</p>
<p>Egy eseményre több trigger is definiálható, melyek lefutási sorrendje nem specifikált. Az első és utolsó triggert megadhatjuk, de más tekintetben nem építhetünk a sorrendre - és alapvetően nem is javasolt úgy dolgozni a triggerekkel, hogy azok egymásra építsenek.</p>
</div>
<h3 id="instead-of-trigger"><em>Instead of</em> trigger<a class="headerlink" href="#instead-of-trigger" title="Permanent link">&para;</a></h3>
<p>A triggerek egy speciális fajtája az ún. <em>instead of trigger</em>. Ilyen triggert táblára és nézetre is definiálhatunk. Nézzük előbb a tábla esetét. Táblára definiált <em>instead of</em> trigger, ahogy a neve sugallja, a végrehajtandó utasítás (<code>insert/update/delete</code>) <em>helyett</em> fut le. Tehát ilyenkor beszúrás esetén az új sorok nem kerültek be a táblába, törlésnél nem kerültek törlésre, módosításnál nem kerültek módosításra. Helyette a triggerben tudjuk definiálni, hogyan kell a műveletet végrehajtani. Az így felüldefiniált működésben hivatkozhatunk a táblára magára és végrehajthatjuk a szükséges utasítást a táblán, amely ebben az esetben nem okoz rekurziót. Ezen triggerek értelmezhetőek valójában <em>utasítás előtti</em> triggerként, mivel a módosítások előtt végezhetünk ellenőrzéseket és szakíthatjuk meg a műveletet hiba esetén.</p>
<p>Tipikus felhasználási esete az <em>instead of</em> triggernek az ellenőrzési feladatokon túl például, ha egy törlést valójában nem akarunk végrehajtani. Ezt szokás <em>soft delete</em>-nek hívni, amikor törlés <em>helyett</em> csak töröltnek jelöljük a rekordokat:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Soft delete flag oszlop a táblába 0 (azaz false) alapértelmezett értékkel</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">Product</span>
<span class="k">add</span> <span class="p">[</span><span class="n">IsDeleted</span><span class="p">]</span> <span class="nb">bit</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">CONSTRAINT</span> <span class="n">DF_Product_IsDeleted</span> <span class="k">DEFAULT</span> <span class="mi">0</span>
<span class="k">go</span>

<span class="c1">-- Instead of trigger, azaz delete utasítás hatására a törlés nem hajtódik végre</span>
<span class="c1">-- helyette az alábbi kód fut le</span>
<span class="k">create</span> <span class="k">or</span> <span class="k">alter</span> <span class="k">trigger</span> <span class="n">ProductSoftDelete</span>
  <span class="k">on</span> <span class="n">Product</span>
  <span class="k">instead</span> <span class="k">of</span> <span class="k">delete</span>
<span class="k">as</span>
<span class="k">update</span> <span class="n">Product</span>
  <span class="k">set</span> <span class="n">IsDeleted</span><span class="o">=</span><span class="mi">1</span>
  <span class="k">where</span> <span class="n">ID</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">ID</span> <span class="k">from</span> <span class="n">deleted</span><span class="p">)</span>
</code></pre></div>
<p>Az <em>instead of</em> triggerek másik tipikus felhasználási esete a nézetek. Egy nézet egy lekérdezés eredménye, tehát nem értelmezhető az a művelet, hogy új adatot szúrunk be a nézetbe. Viszont egy <em>instead of</em> triggerrel definiálhatjuk, mit kell a "nézetbe beszúrás" <em>helyett</em> végrehajtani. Nézzünk erre egy példát. A nézetben a termék és áfa táblákból kapcsoljuk össze az adatokat úgy, hogy ne a hivatkozott áfa rekord azonosítója, hanem az áfa százaléka jelenjen meg a nézetben. Ebbe a nézetbe úgy tudunk beszúrni, ha a mögötte levő termékeket tároló táblába szúrunk be:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Nézet definiálása</span>
<span class="k">create</span> <span class="k">view</span> <span class="n">ProductWithVatPercentage</span>
<span class="k">as</span>
<span class="k">select</span> <span class="n">p</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">Percentage</span>
<span class="k">from</span> <span class="n">Product</span> <span class="n">p</span> <span class="k">join</span> <span class="n">Vat</span> <span class="n">v</span> <span class="k">on</span> <span class="n">p</span><span class="p">.</span><span class="n">VATID</span><span class="o">=</span><span class="n">v</span><span class="p">.</span><span class="n">Id</span>

<span class="c1">-- Instead of trigger a nézetre a beszúrás helyett</span>
<span class="k">create</span> <span class="k">or</span> <span class="k">alter</span> <span class="k">trigger</span> <span class="n">ProductWithVatPercentageInsert</span>
<span class="k">on</span> <span class="n">ProductWithVatPercentage</span>
<span class="k">instead</span> <span class="k">of</span> <span class="k">insert</span>
<span class="k">as</span>
  <span class="c1">-- A beszúrás a Product táblába kerül, minden inserted rekordnak egy új sora keletkezik</span>
  <span class="c1">-- És közben kikeressük a százaléknak megfelelő áfa rekordot</span>
  <span class="c1">-- A megoldás nem teljes, mert nem kezeli, ha nincs még ilyen áfa rekord</span>
  <span class="k">insert</span> <span class="k">into</span> <span class="n">Product</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">VATID</span><span class="p">,</span> <span class="n">CategoryID</span><span class="p">)</span>
  <span class="k">select</span> <span class="n">i</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">from</span> <span class="n">inserted</span> <span class="n">i</span> <span class="k">join</span> <span class="n">Vat</span> <span class="n">v</span> <span class="k">on</span> <span class="n">v</span><span class="p">.</span><span class="n">Percentage</span> <span class="o">=</span> <span class="n">i</span><span class="p">.</span><span class="n">Percentage</span>

<span class="c1">-- A trigger kipróbálható a nézetbe való beszúrással</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">ProductWithVatPercentage</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Stock</span><span class="p">,</span> <span class="n">Percentage</span><span class="p">)</span>
<span class="k">values</span> <span class="p">(</span><span class="s1">&#39;Red ball&#39;</span><span class="p">,</span> <span class="mi">1234</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">27</span><span class="p">)</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Élőláb">
      
        
        <a href="../sql/" class="md-footer__link md-footer__link--prev" aria-label="Előző: SQL nyelv, MSSQL platformfüggő SQL utasítások" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Előző
              </span>
              SQL nyelv, MSSQL platformfüggő SQL utasítások
            </div>
          </div>
        </a>
      
      
        
        <a href="../../adonet/" class="md-footer__link md-footer__link--next" aria-label="Következő: ADO.NET adatelérés" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Következő
              </span>
              ADO.NET adatelérés
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; BME VIK AUT
          </div>
        
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.instant", "navigation.top", "search.suggest"], "translations": {"clipboard.copy": "M\u00e1sol\u00e1s v\u00e1g\u00f3lapra", "clipboard.copied": "V\u00e1g\u00f3lapra m\u00e1solva", "search.config.lang": "hu", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Keres\u00e9s", "search.result.placeholder": "Keres\u00e9shez \u00edrj ide valamit", "search.result.none": "Nincs tal\u00e1lat", "search.result.one": "1 egyez\u0151 dokumentum", "search.result.other": "# egyez\u0151 dokumentum", "search.result.more.one": "1 tov\u00e1bbi tal\u00e1lat az oldalon", "search.result.more.other": "# tov\u00e1bbi tal\u00e1lat az oldalon", "search.result.term.missing": "\u00dcres", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.b1047164.min.js"></script>
      
    
  </body>
</html>