
<!doctype html>
<html lang="hu" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="Dudás Ákos">
      
      
      <link rel="icon" href="../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>MongoDB alapok, műveletek, és a MongoDB .NET Driver - BMEVIAUAC01 Adatvezérelt rendszerek</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../extra-material-theme.css">
    
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="aut" data-md-color-primary="red" data-md-color-accent="red">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mongodb-alapok-muveletek-es-a-mongodb-net-driver" class="md-skip">
          Kihagyás
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Élőfej">
    <a href="../.." title="BMEVIAUAC01 Adatvezérelt rendszerek" class="md-header__button md-logo" aria-label="BMEVIAUAC01 Adatvezérelt rendszerek" data-md-component="logo">
      
  <img src="../../img/logo-bme-aut.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BMEVIAUAC01 Adatvezérelt rendszerek
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              MongoDB alapok, műveletek, és a MongoDB .NET Driver
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="aut" data-md-color-primary="red" data-md-color-accent="red"  aria-label="Váltás sötét témára"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Váltás sötét témára" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent=""  aria-label="Váltás világos témára"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Váltás világos témára" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Keresés" placeholder="Keresés" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Törlés" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Keresés inicializálása
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/bmeviauac01/adatvezerelt/" title="Főoldalra ugrás" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    bmeviauac01/adatvezerelt
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Lapok" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Adatvezérelt rendszerek
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../db/" class="md-tabs__link">
        Adatbázis
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../architektura/" class="md-tabs__link md-tabs__link--active">
        Jegyzetek
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../gyakorlat/transactions/" class="md-tabs__link">
        Gyakorlatok
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../hazi/" class="md-tabs__link">
        Házi feladatok
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigáció" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="BMEVIAUAC01 Adatvezérelt rendszerek" class="md-nav__button md-logo" aria-label="BMEVIAUAC01 Adatvezérelt rendszerek" data-md-component="logo">
      
  <img src="../../img/logo-bme-aut.png" alt="logo">

    </a>
    BMEVIAUAC01 Adatvezérelt rendszerek
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/bmeviauac01/adatvezerelt/" title="Főoldalra ugrás" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    bmeviauac01/adatvezerelt
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Adatvezérelt rendszerek
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Adatbázis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Adatbázis" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Adatbázis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db/" class="md-nav__link">
        Minta adatbázis sémája
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db/mssql/" class="md-nav__link">
        Microsoft SQL Server használata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db/mongodb/" class="md-nav__link">
        MongoDB használata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://raw.githubusercontent.com/bmeviauac01/adatvezerelt/master/docs/db/mssql.sql" class="md-nav__link">
        Minta adatbázis: mssql.sql
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://raw.githubusercontent.com/bmeviauac01/adatvezerelt/master/docs/db/mongo.js" class="md-nav__link">
        Minta adatbázis: mongo.js
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Jegyzetek
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Jegyzetek" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Jegyzetek
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../architektura/" class="md-nav__link">
        Adatvezérelt rendszerek és a többrétegű (háromrétegű) architektúra
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../transactions/" class="md-nav__link">
        Tranzakciókezelés adatbázisokban
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mssql/sql/" class="md-nav__link">
        SQL nyelv, MSSQL platformfüggő SQL utasítások
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mssql/server-side-programming/" class="md-nav__link">
        Microsoft SQL Server programozása
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../adonet/" class="md-nav__link">
        ADO.NET adatelérés
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../linq/" class="md-nav__link">
        LINQ: Language Integrated Query
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ef/" class="md-nav__link">
        Kapcsolatok definiálása Entity Framework-ben
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          MongoDB alapok, műveletek, és a MongoDB .NET Driver
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        MongoDB alapok, műveletek, és a MongoDB .NET Driver
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Tartalomjegyzék">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tartalomjegyzék
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nosql-adatbazisok" class="md-nav__link">
    NoSQL adatbázisok
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-mongodb-alap-koncepcioi" class="md-nav__link">
    A MongoDB alap koncepciói
  </a>
  
    <nav class="md-nav" aria-label="A MongoDB alap koncepciói">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logikai-felepites" class="md-nav__link">
    Logikai felépítés
  </a>
  
    <nav class="md-nav" aria-label="Logikai felépítés">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dokumentum" class="md-nav__link">
    Dokumentum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gyujtemeny" class="md-nav__link">
    Gyűjtemény
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adatbazis" class="md-nav__link">
    Adatbázis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kulcs" class="md-nav__link">
    Kulcs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mongodb-muveletek-es-a-mongodb-net-driver" class="md-nav__link">
    MongoDB műveletek és a MongoDB .NET Driver
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kapcsolat-letesitese" class="md-nav__link">
    Kapcsolat létesítése
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gyujtemenyek-kezelese" class="md-nav__link">
    Gyűjtemények kezelése
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dokumentumok-lekepzese-c-objektumokra" class="md-nav__link">
    Dokumentumok leképzése C# objektumokra
  </a>
  
    <nav class="md-nav" aria-label="Dokumentumok leképzése C# objektumokra">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-lekepzes-testreszabasa" class="md-nav__link">
    A leképzés testreszabása
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lekerdezesek" class="md-nav__link">
    Lekérdezések
  </a>
  
    <nav class="md-nav" aria-label="Lekérdezések">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lekerdezes-eredmenyenek-felhasznalasa" class="md-nav__link">
    Lekérdezés eredményének felhasználása
  </a>
  
    <nav class="md-nav" aria-label="Lekérdezés eredményének felhasználása">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#listazas" class="md-nav__link">
    Listázás
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsoegyetlen-elem-lekerese" class="md-nav__link">
    Első/egyetlen elem lekérése
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kurzor" class="md-nav__link">
    Kurzor
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#szureshez-hasznalhato-operatorok" class="md-nav__link">
    Szűréshez használható operátorok
  </a>
  
    <nav class="md-nav" aria-label="Szűréshez használható operátorok">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#osszehasonlitasi-operatorok" class="md-nav__link">
    Összehasonlítási operátorok
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logikai-operatorok" class="md-nav__link">
    Logikai operátorok
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tobb-ertek-kozul-valamelyikkel-megegyezo" class="md-nav__link">
    Több érték közül valamelyikkel megegyező
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ertek-letezik-nem-null" class="md-nav__link">
    Érték létezik (nem null)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#szures-beagyazott-dokumentum-mezojere" class="md-nav__link">
    Szűrés beágyazott dokumentum mezőjére
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#szures-tomb-erteku-mezore" class="md-nav__link">
    Szűrés tömb értékű mezőre
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lekerdezes-vegrehajto-pipeline" class="md-nav__link">
    Lekérdezés-végrehajtó pipeline
  </a>
  
    <nav class="md-nav" aria-label="Lekérdezés-végrehajtó pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lapozas-rendezes" class="md-nav__link">
    Lapozás, rendezés
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#darabszam-lekerdezes" class="md-nav__link">
    Darabszám lekérdezés
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregacios-pipeline" class="md-nav__link">
    Aggregációs pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beszuras-modositas-torles" class="md-nav__link">
    Beszúrás, módosítás, törlés
  </a>
  
    <nav class="md-nav" aria-label="Beszúrás, módosítás, törlés">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uj-dokumentum-beszurasa" class="md-nav__link">
    Új dokumentum beszúrása
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dokumentumok-torlese" class="md-nav__link">
    Dokumentumok törlése
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dokumentumok-megvaltoztatasa" class="md-nav__link">
    Dokumentumok megváltoztatása
  </a>
  
    <nav class="md-nav" aria-label="Dokumentumok megváltoztatása">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dokumentum-teljes-csereje" class="md-nav__link">
    Dokumentum teljes cseréje
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dokumentum-modosito-operatorok" class="md-nav__link">
    Dokumentum módosító operátorok
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upsert-beszuras-vagy-modositas" class="md-nav__link">
    Upsert: beszúrás vagy módosítás
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../di/" class="md-nav__link">
        Függőséginjektálás ASP.NET Core környezetben
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../async/" class="md-nav__link">
        Aszinkron kérések és DTO-k (példa WebAPI alkalmazás)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../openapi/" class="md-nav__link">
        OpenAPI 3 és a Swagger
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/bmeviauac01/rest-webapi-sample" class="md-nav__link">
        REST és WebAPI demó alkalmazás (GitHub)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/bmeviauac01/todoapi-di-sample" class="md-nav__link">
        ASP.NET Core DI demó alkalmazás (GitHub)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/bmeviauac01/threelayered-aspnetcore-sample" class="md-nav__link">
        Minta többrétegű webalkalmazás (GitHub)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Gyakorlatok
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Gyakorlatok" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Gyakorlatok
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gyakorlat/transactions/" class="md-nav__link">
        Tranzakciókezelés
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gyakorlat/mssql/" class="md-nav__link">
        Microsoft SQL Server programozása
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gyakorlat/ef/" class="md-nav__link">
        Entity Framework
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gyakorlat/mongodb/" class="md-nav__link">
        MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gyakorlat/jpa/" class="md-nav__link">
        JPA & Spring Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gyakorlat/rest/" class="md-nav__link">
        REST API & ASP.NET Web API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Házi feladatok
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Házi feladatok" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Házi feladatok
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hazi/" class="md-nav__link">
        Szorgalmi házi feladatok
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hazi/mssql/" class="md-nav__link">
        Feladat: MSSQL szerveroldali programozás
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hazi/adonet/" class="md-nav__link">
        Feladat: ADO.NET adatelérés
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hazi/ef/" class="md-nav__link">
        Feladat: Entity Framework
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hazi/mongodb/" class="md-nav__link">
        Feladat: MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hazi/rest/" class="md-nav__link">
        Feladat: REST API Web API technológiával
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hazi/GitHub/" class="md-nav__link">
        Feladatok beadása (GitHub)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hazi/GitHub-Actions/" class="md-nav__link">
        GitHub Actions ismertető
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hazi/VisualStudio/" class="md-nav__link">
        Visual Studio & .NET SDK telepítése
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Tartalomjegyzék">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tartalomjegyzék
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#nosql-adatbazisok" class="md-nav__link">
    NoSQL adatbázisok
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-mongodb-alap-koncepcioi" class="md-nav__link">
    A MongoDB alap koncepciói
  </a>
  
    <nav class="md-nav" aria-label="A MongoDB alap koncepciói">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logikai-felepites" class="md-nav__link">
    Logikai felépítés
  </a>
  
    <nav class="md-nav" aria-label="Logikai felépítés">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dokumentum" class="md-nav__link">
    Dokumentum
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gyujtemeny" class="md-nav__link">
    Gyűjtemény
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adatbazis" class="md-nav__link">
    Adatbázis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kulcs" class="md-nav__link">
    Kulcs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mongodb-muveletek-es-a-mongodb-net-driver" class="md-nav__link">
    MongoDB műveletek és a MongoDB .NET Driver
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kapcsolat-letesitese" class="md-nav__link">
    Kapcsolat létesítése
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gyujtemenyek-kezelese" class="md-nav__link">
    Gyűjtemények kezelése
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dokumentumok-lekepzese-c-objektumokra" class="md-nav__link">
    Dokumentumok leképzése C# objektumokra
  </a>
  
    <nav class="md-nav" aria-label="Dokumentumok leképzése C# objektumokra">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-lekepzes-testreszabasa" class="md-nav__link">
    A leképzés testreszabása
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lekerdezesek" class="md-nav__link">
    Lekérdezések
  </a>
  
    <nav class="md-nav" aria-label="Lekérdezések">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lekerdezes-eredmenyenek-felhasznalasa" class="md-nav__link">
    Lekérdezés eredményének felhasználása
  </a>
  
    <nav class="md-nav" aria-label="Lekérdezés eredményének felhasználása">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#listazas" class="md-nav__link">
    Listázás
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#elsoegyetlen-elem-lekerese" class="md-nav__link">
    Első/egyetlen elem lekérése
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kurzor" class="md-nav__link">
    Kurzor
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#szureshez-hasznalhato-operatorok" class="md-nav__link">
    Szűréshez használható operátorok
  </a>
  
    <nav class="md-nav" aria-label="Szűréshez használható operátorok">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#osszehasonlitasi-operatorok" class="md-nav__link">
    Összehasonlítási operátorok
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logikai-operatorok" class="md-nav__link">
    Logikai operátorok
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tobb-ertek-kozul-valamelyikkel-megegyezo" class="md-nav__link">
    Több érték közül valamelyikkel megegyező
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ertek-letezik-nem-null" class="md-nav__link">
    Érték létezik (nem null)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#szures-beagyazott-dokumentum-mezojere" class="md-nav__link">
    Szűrés beágyazott dokumentum mezőjére
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#szures-tomb-erteku-mezore" class="md-nav__link">
    Szűrés tömb értékű mezőre
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lekerdezes-vegrehajto-pipeline" class="md-nav__link">
    Lekérdezés-végrehajtó pipeline
  </a>
  
    <nav class="md-nav" aria-label="Lekérdezés-végrehajtó pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lapozas-rendezes" class="md-nav__link">
    Lapozás, rendezés
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#darabszam-lekerdezes" class="md-nav__link">
    Darabszám lekérdezés
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregacios-pipeline" class="md-nav__link">
    Aggregációs pipeline
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#beszuras-modositas-torles" class="md-nav__link">
    Beszúrás, módosítás, törlés
  </a>
  
    <nav class="md-nav" aria-label="Beszúrás, módosítás, törlés">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uj-dokumentum-beszurasa" class="md-nav__link">
    Új dokumentum beszúrása
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dokumentumok-torlese" class="md-nav__link">
    Dokumentumok törlése
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dokumentumok-megvaltoztatasa" class="md-nav__link">
    Dokumentumok megváltoztatása
  </a>
  
    <nav class="md-nav" aria-label="Dokumentumok megváltoztatása">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dokumentum-teljes-csereje" class="md-nav__link">
    Dokumentum teljes cseréje
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dokumentum-modosito-operatorok" class="md-nav__link">
    Dokumentum módosító operátorok
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upsert-beszuras-vagy-modositas" class="md-nav__link">
    Upsert: beszúrás vagy módosítás
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/bmeviauac01/adatvezerelt/edit/master/docs/jegyzet/mongodb/index.md" title="Oldal szerkesztése" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="mongodb-alapok-muveletek-es-a-mongodb-net-driver">MongoDB alapok, műveletek, és a MongoDB .NET Driver<a class="headerlink" href="#mongodb-alapok-muveletek-es-a-mongodb-net-driver" title="Permanent link">&para;</a></h1>
<h2 id="nosql-adatbazisok">NoSQL adatbázisok<a class="headerlink" href="#nosql-adatbazisok" title="Permanent link">&para;</a></h2>
<p>A NoSQL adatbázisok a relációs sémától eltérően működő adatbázisok összefoglaló neve. A név valamennyire megtévesztő, mert a fogalomnak kevés köze van az SQL nyelvhez - ehelyett a releváns különbség az adatreprezentációban és a sémában van. De mégis miért van szükségünk új fajta adatbázisokra, amikor a relációs adatbázisok régóta jól használhatóak?</p>
<ol>
<li>Skálázás lehet kihívás a relációs adatbázisok esetén<ul>
<li>Bizonyos méret fölé</li>
<li>Globális elérhetőség</li>
<li>Rendelkezésreállás biztosítása    </li>
</ul>
</li>
<li>Nem-strukturált adatok tárolása esetén inkább a hátrányok jelentkeznek</li>
</ol>
<p>Ezekre a problémákra a NoSQL adatbázisok nyújtanak megoldást, azonban használatuk megával <strong>hoz új kihívásokat</strong> is. Ebben a világban <strong>elhagyjuk a szigorú sémákat, helyette egy flexibilis sémát fogunk alkalmazni</strong>. Azaz nem lesznek erős elvárásaink az adatbázisban tárolt adatokkal szemben. Ez komoly hatással van az üzleti logikára: milyen osztályokat hozunk létre, a logika milyen adatok kitöltöttségére számít és a felhasználói felületre, ott milyen adatokat hogy jelenítünk meg, kérünk be és validálunk.</p>
<h2 id="a-mongodb-alap-koncepcioi">A MongoDB alap koncepciói<a class="headerlink" href="#a-mongodb-alap-koncepcioi" title="Permanent link">&para;</a></h2>
<p>A MongoDB egy kliens-szerver architektúrájú nem-relációs adatbázis. A kép jobb oldalán látható a <em>mongod</em>, azaz Mongo démon, vagyis az a processz, ami az adatbázis elérését biztosítja. A másik oldal a mi alkalmazásunk, ahonnan a kliens kapcsolódik a szerverhez egy hálózati kapcsolaton keresztül. Ez a hálózati kapcsolat az ún. <em>wire protocol</em>-on keresztül történik, ez a MongoDB saját protokollja. Ebben a protokollban JSON formájú adat kommunikáció zajlik binárisan (azaz BSON).</p>
<p><img alt="A MongoDb architektúrája" src="images/mongodb_rendszer_architektura.png" /></p>
<h3 id="logikai-felepites">Logikai felépítés<a class="headerlink" href="#logikai-felepites" title="Permanent link">&para;</a></h3>
<p>Egy MongoDB-alapú adatbázis rendszer legfelső rétege az ún. <em>klaszter</em>, ebbe szervezzük a szervereket. Mi klaszterekkel ebben a tárgyban nem foglalkozunk, azok a skálázás eszközei. A második szint a szerver szintje (a <em>mongod</em> processz), ami alatt az adatbázis foglal helyet. Egy szerver/klaszter több adatbázist tárolhat. Az adatbázisok pedig gyűjteményekből (<em>collection</em>) épülnek fel. Ha a relációs adatbázisokkal meg akarjuk feleltetni, akkor a gyűjtemények a táblák megfelelői, ezen belül a sorok/rekordok pedig a gyűjteményben tárolt <em>dokumentumok</em> lesznek.</p>
<p>Nézzük ezeket pontosabban.</p>
<h4 id="dokumentum">Dokumentum<a class="headerlink" href="#dokumentum" title="Permanent link">&para;</a></h4>
<p>A dokumentum a MongoDB alap tárolási egysége. Egy dokumentum egy JSON (jellegű) fájl, tehát kulcs-érték párokat tartalmaz. Maga a MongoDB BSON-ként, bináris reprezentációként tárolja mindezt.</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="s">&quot;sue&quot;</span><span class="p">,</span>
    <span class="n">age</span><span class="p">:</span> <span class="m">26</span><span class="p">,</span>
    <span class="n">status</span><span class="p">:</span> <span class="s">&quot;A&quot;</span><span class="p">,</span>
    <span class="n">groups</span><span class="p">:</span> <span class="p">[</span> <span class="s">&quot;news&quot;</span><span class="p">,</span> <span class="s">&quot;sports&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>Kulcsoknak többnyire bármilyen szabad szöveget választhatunk, de a neveknek egyedinek kell lenniük és nem kezdődhetnek a <code>$</code> karakterrel. A nevek case sensitive-ek. Az érték lehet szöveg, szám, dátum, bináris, beágyazott elem, <code>null</code>, vagy akár a fenti példában a <code>groups</code> kulcsnál láthatóan tömb is - relációs adatbázisban ezt így nem lehet reprezentálni.</p>
<p>Az objektum orientált világban egy dokumentum felel meg egy objektumnak. Fontos megkötés, hogy a dokumentumok maximális mérete 16MB lehet, és ez nem konfigurálható érték.</p>
<h4 id="gyujtemeny">Gyűjtemény<a class="headerlink" href="#gyujtemeny" title="Permanent link">&para;</a></h4>
<p>Relációs tábla analógiája a gyűjtemény, de nincs sémája, így ezeket létrehozni, definiálni se kell, első használatkor a rendszer automatikusan létrehozza őket. Úgy fogalmazhatjuk meg, hogy a gyűjtemény a "hasonló" dokumentumok gyűjtőhelye. Bár nincs séma, <em>indexeket</em> ennek ellenére definiálhatunk a gyűjteményeken, amely a gyors keresést fogják segíteni. Séma hiányában nincs tartományi integritási kritérium, tehát például a helyes adattípusok és tartományi kritériumok biztosításában az adatbázis nem nyújt segítséget.</p>
<h4 id="adatbazis">Adatbázis<a class="headerlink" href="#adatbazis" title="Permanent link">&para;</a></h4>
<p>Az adatbázis ugyanazt a célt szolgálja, mint relációs adatbázisban. Ez fogja össze az alkalmazás adatait logikailag. Illetve hozzáférési jogosultságokat adatbázis szinten tudunk adni. Az adatbázisok neve case sensitive és konvenció szerint tipikusan csupa kisbetű.</p>
<h4 id="kulcs">Kulcs<a class="headerlink" href="#kulcs" title="Permanent link">&para;</a></h4>
<p>Minden dokumentum egyértelmű azonosítója az <code>_id</code> mező, más kulcsot nem tudunk definiálni. Ezt a mezőt beszúráskor nem szükséges explicit megadni (de lehet), tipikusan a kliens driver vagy a szerver generálja (alapértelmezésben egy 12 bájtos <code>ObjectId</code>-t készít).</p>
<p>Az <code>_id</code> mezőtől függetlenül egyediséget indexek segítségével tudunk garantálni. Amennyiben szükséges, definiálhatunk tehát más, kulcs-szerű mezőket is. Az így definiált egyedi mezők lehetnek összetettek is (tehát lehet több mező együttes egyediségét előírni).</p>
<p>Külső kulcs hivatkozások MongoDB-ben nincsenek. Tudunk hivatkozni más dokumentumokra azok kulcsainak bemásolásával, azonban ezekre a rendszer nem vállal garanciát (pl. a hivatkozott dokumentum törölhető).</p>
<h2 id="mongodb-muveletek-es-a-mongodb-net-driver">MongoDB műveletek és a MongoDB .NET Driver<a class="headerlink" href="#mongodb-muveletek-es-a-mongodb-net-driver" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p>Az alábbi, illusztrációra használt kódrészletek a hivatalos <a href="https://www.nuget.org/packages/mongodb.driver">MongoDB.Driver</a> NuGet csomagot használják.</p>
</div>
<h2 id="kapcsolat-letesitese">Kapcsolat létesítése<a class="headerlink" href="#kapcsolat-letesitese" title="Permanent link">&para;</a></h2>
<p>A MongoDB adatbázis eléréséhez első lépésben szükségünk van egy kapcsolatra. A kapcsolatot egy <code>MongoClient</code> osztály reprezentálja. A kapcsolathoz szükségünk van a szerver elérhetőségére (a connection stringről részletesebben lásd: <a href="https://docs.mongodb.com/manual/reference/connection-string/">https://docs.mongodb.com/manual/reference/connection-string/</a>).</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s">&quot;mongodb://localhost:27017&quot;</span><span class="p">);</span>
</code></pre></div>
<p>A kapcsolatot singleton-ként érdemes kezelni, nem kell Dispose-olni.</p>
<div class="admonition info">
<p class="admonition-title">Kapcsolat életciklusa</p>
<p>A kapcsolatot tipikusan egy globális statikus változóban tároljuk, avagy a környezet által támogatott IoC (Inversion of Control) / DI (Dependency Injection) tárolóban helyezzük el.</p>
</div>
<p>Az adatbázis neve szerepelhet ugyan a connection stringben (pl. <code>mongodb://localhost:27017/adatvez</code>), azt csak az authentikációhoz használja a rendszer. Így a kapcsolat felépítése után meg kell adnunk, milyen adatbázist fogunk használni.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">db</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">GetDatabase</span><span class="p">(</span><span class="s">&quot;adatvez&quot;</span><span class="p">);</span>
</code></pre></div>
<p>Az adatbázisnak nem kell előzetesen létezni. A fenti hívás hatására, ha még nem létezik az adatbázis, automatikusan létrejön.</p>
<h2 id="gyujtemenyek-kezelese">Gyűjtemények kezelése<a class="headerlink" href="#gyujtemenyek-kezelese" title="Permanent link">&para;</a></h2>
<p>Egy relációs adatbázistól eltérően <strong>MongoDB-ben a műveleteinket mindig egyetlen gyűjteményen végezzük</strong>, így a gyűjtemény kiválasztása nem a kiadott parancs része (mint az SQL nyelvben a <code>from</code>), hanem a művelet előfeltétele. Egy adott gyűjteményt a <code>GetCollection</code> hívással kaphatunk meg, generikus paramétere a dokumentum típust megvalósító C# osztály.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">collection</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">GetCollection</span><span class="p">&lt;</span><span class="n">BsonDocument</span><span class="p">&gt;(</span><span class="s">&quot;products&quot;</span><span class="p">);</span>
</code></pre></div>
<p>A .NET MongoDB driver alap koncepciója szerint minden dokumentumot leképez egy .NET objektumra. Ezzel automatikusan megvalósítja az ún. <em>ODM (Object Document Mapping)</em> funkciót. Az ODM az ORM megfelelője a NoSQL adatbázisok világában.</p>
<div class="admonition warning">
<p class="admonition-title">"Nyers" json</p>
<p>Más nyelveken és platformokon a MongoDB driverek nem mindig végzik el a leképezést objektumokra, így az interneten található példákban gyakran "nyers" JSON dokumentumokon keresztüli kommunikációt mutatnak. Igyekezzünk ezt elkerülni, ahogy az ORM témakörében megtanultuk, kényelmesebb és biztonságosabb az objektumorientált leképzés.</p>
</div>
<p>Az előző példában <code>BsonDocument</code> típusú dokumentumot használunk. A <code>BsonDocument</code> egy általános dokumentum reprezentáció, amiben kulcs-érték párokat tárolhatunk. Használata kényelmetlen és nem típusbiztos, ezért általában nem ezt a megoldást használjuk. A javasolt megoldást lásd hamarosan.</p>
<p>A gyűjteményt reprezentáló változón tudunk további műveleteket futtatni, például beszúrunk egy dokumentumot, majd listázzuk a gyűjtemény tartalmát. A gyűjtemény első használatkor automatikusan létre fog jönni, azaz semmilyen módon nem szükséges definiálnunk.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">InsertOne</span><span class="p">(</span><span class="k">new</span> <span class="n">BsonDocument</span><span class="p">()</span>
<span class="p">{</span>
    <span class="p">{</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;Apple&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;categoryName&quot;</span><span class="p">,</span> <span class="s">&quot;Apple&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;price&quot;</span><span class="p">,</span> <span class="m">123</span> <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// minden dokumentum listázása: szükség van egy szűrési feltételre, ami itt</span>
<span class="c1">// egy üres feltétel, azaz minden dokumentumra illeszkedik</span>
<span class="kt">var</span> <span class="n">list</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="k">new</span> <span class="n">BsonDocument</span><span class="p">()).</span><span class="n">ToList</span><span class="p">();</span>
<span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">l</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Elnevezési konvenció</p>
<p>A dokumentumban a kulcs nevek konvenció szerint kisbetűvel kezdődnek, mint <code>price</code> vagy <code>categoryName</code> (ez az ún. <em>camel case</em> írásmód). Ez a szokás a MongoDB világának megfelelő szemlélet historikus okokból. Hacsak nincs jó okunk rá, ne térjünk el ettől.</p>
</div>
<h2 id="dokumentumok-lekepzese-c-objektumokra">Dokumentumok leképzése C# objektumokra<a class="headerlink" href="#dokumentumok-lekepzese-c-objektumokra" title="Permanent link">&para;</a></h2>
<p>Ahogy a relációs adatbázisoknál láthattuk az objektum-relációs leképzést, MongoDB esetén is célszerű objektumokkal és osztályokkal dolgoznunk. A MongoDB .NET drivere ezt teljes mértékben biztosítja számunkra.</p>
<p>Első lépésként definiálnunk kell a C# osztályt, ill. osztályokat, amikre az adatbázis tartalmát leképezzük. Mivel itt nincs az adatbázisnak és táblának sémája, nem tudjuk a séma alapján generálni a C# kódot (mint Entity Framework esetén csináltuk). Így ebben a világban inkább a <em>Code First</em> elvet követjük, azaz a C# kódot készítjük el, és abból készül az adatbázis és gyűjtemény (habár tudjuk, hogy itt nincs szó az osztály alapján táblák létrehozásáról).</p>
<p>Definiáljuk a <em>Termékek</em> reprezentáláshoz az alábbi osztályokat.</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ObjectId</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// ez lesz az elsődleges kulcs helyett az _id azonosító</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Stock</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span><span class="p">[]</span> <span class="n">Categories</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// tömb értékű mező</span>
    <span class="k">public</span> <span class="n">VAT</span> <span class="n">VAT</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// beágyazást alkalmazunk</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">VAT</span> <span class="c1">// mivel ez beágyazott entitás, így nem adunk neki egyedi azonosítót</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">VATCategoryName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">Percentage</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Figyeljük meg, hogy korábban <code>price</code> néven használtuk a dokumentumban a kulcsot, de a C# osztályban az ún. <em>Pascal Case</em> szerint nagybetűvel kezdjük: <code>Price</code>. A MongoDB .NET drivere beépül a C# nyelvbe és a .NET környezetbe, és annak szokásait tiszteletben tartja, így az osztály definícióban szereplő mező nevek és a MongoDB dokumentumaiban a kulcsok leképzése automatikusan meg fog történni, a <code>Price</code> osztály tulajdonságból <code>price</code> kulcs név lesz a dokumentumban.</p>
<h3 id="a-lekepzes-testreszabasa">A leképzés testreszabása<a class="headerlink" href="#a-lekepzes-testreszabasa" title="Permanent link">&para;</a></h3>
<p>A C# osztály - MongoDB dokumentum leképzés automatikus, de testreszabható. Amennyiben el szeretnénk térni az alap konvencióktól, több féle módon is megtehetjük.</p>
<p>A legegyszerűbb, ha az osztály definíciójában attribútumokkal jelöljük a testreszabást:</p>
<div class="highlight"><pre><span></span><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Product</span>
<span class="p">{</span>
    <span class="c1">// _id mezőre képződik le</span>
<span class="na">    [BsonId]</span>
    <span class="k">public</span> <span class="n">ObjectId</span> <span class="n">Azonosito</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">// megadhatjuk a MongoDB dokumentumban használatos nevet</span>
<span class="na">    [BsonElement(&quot;price&quot;)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Ar</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">// kihagyhatunk egyes mezőket</span>
<span class="na">    [BsonIgnore]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">NemMentett</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Másik lehetőségünk magasabb szinten ún. konvenció-csomagokat beregisztrálni. A konvenció-csomagok általánosan leírják, hogyan történjen a leképezés. (Az alap viselkedés is egy konvenció-csomag alapján definiált.)</p>
<p>Például az alábbiakkal megadhatjuk, hogy camel case-re szeretnénk a mező neveket leképezni, valamint a default értékkel rendelkező adattagokat (C# nyelv szerint definiált default érték) szeretnénk kihagyni a dokumentumból.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// konvenciók definiálása</span>
<span class="kt">var</span> <span class="n">pack</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ConventionPack</span><span class="p">();</span>
<span class="n">pack</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">CamelCaseElementNameConvention</span><span class="p">());</span>
<span class="n">pack</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">IgnoreIfDefaultConvention</span><span class="p">(</span><span class="k">true</span><span class="p">));</span>

<span class="c1">// konvenciók beregisztrálása</span>
<span class="c1">// az első paraméter egy név</span>
<span class="c1">// az utolsó paraméterrel szűrési feltételt adhatunk meg, hol használandóak a konvenciók</span>
<span class="n">ConventionRegistry</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;adatvez&quot;</span><span class="p">,</span> <span class="n">pack</span><span class="p">,</span> <span class="n">t</span> <span class="p">=&gt;</span> <span class="k">true</span><span class="p">);</span>
</code></pre></div>
<p>Ennél bonyolultabb testreszabásokra is lehetőségünk van, például definiálhatunk konverziós logikát a C# reprezentáció és a MongoDB reprezentáció közötti fordításhoz, illetve megadhatjuk a leszármazási hierarchia mentésének módját. Ezekről részletesebben a hivatalos dokumentációban: <a href="https://mongodb.github.io/mongo-csharp-driver/2.8/reference/bson/serialization/">https://mongodb.github.io/mongo-csharp-driver/2.8/reference/bson/serialization/</a>.</p>
<h2 id="lekerdezesek">Lekérdezések<a class="headerlink" href="#lekerdezesek" title="Permanent link">&para;</a></h2>
<p>A továbbiakban a típusos, <code>Product</code> osztályra leképző módon használjuk a gyűjteményt, és így végzünk műveletet. Ez a javasolt megoldás, a <code>BsonDocument</code> alapú megoldást csak szükség esetén használjuk.</p>
<p>A legegyszerűbb lekérdezést már láthattuk, listázzunk minden dokumentumot:</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">collection</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">GetCollection</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="s">&quot;products&quot;</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">lista</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="k">new</span> <span class="n">BsonDocument</span><span class="p">()).</span><span class="n">ToList</span><span class="p">();</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">p</span> <span class="k">in</span> <span class="n">lista</span><span class="p">)</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&quot;Id: {p.Id}, Name: {p.Name}&quot;</span><span class="p">);</span>
</code></pre></div>
<p>A listázás a <code>Find</code> metódussal történik. Az elnevezés jól mutatja a MongoDB filozófiáját: az adatbázis keresésre való, minden elem listázása nem praktikus, ezért nincs is rá egyszerű szintaktika. A <code>Find</code> egy keresési feltételt vár, ami itt egy üres feltétel, azaz mindenre illeszkedik.</p>
<p>A keresési feltételt több féle módon leírhatjuk.</p>
<p>A <strong><code>BsonDocument</code></strong> alapú szűrésben nyersen, a MongoDB szintaktikája szerint kell megírni a szűrési feltételt. Erre lehetőségünk van ugyan, de elkerüljük, mert a MongoDB .NET drivere ezt megoldja számunkra, ha az alábbiak szerint adjuk meg a keresési feltételt.</p>
<p>A legtöbb esetben egy <strong>Lambda-kifejezéssel</strong> leírhatjuk a feltételt.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">123</span><span class="p">);</span>
</code></pre></div>
<p>Ilyenkor a Lambda-kifejezés egy <code>Predicate&lt;T&gt;</code> típusú delegate, azaz a megadott osztálytípuson (itt: <code>Product</code>) fogalmazzuk meg, és <code>bool</code> visszatérési értékű. Tehát a fenti példában az <code>x</code> változó egy <code>Product</code> objektumot reprezentál. Ez a keresés működik természetesen bonyolultabb esetekre is.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">123</span> <span class="p">&amp;&amp;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&quot;red&quot;</span><span class="p">));</span>
</code></pre></div>
<p>A Lambda kifejezésekkel leírt szűrési feltételek elrejtik, hogy a MongoDB-ben valójában milyen keresési feltételeink is vannak. Például az előbbi <code>Contains</code> keresési feltétel egy reguláris kifejezéssel való keresést fog valójában jelenteni.</p>
<p>A MongoDB saját nyelvén az előbbi szűrés így néz ki:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;price&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;$lt&quot;</span><span class="p">:</span> <span class="mf">123.0</span>
  <span class="p">},</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;/red/s&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>Vegyük észre, hogy ez a fajta leírás önmaga is egy dokumentum. Ha saját magunk akarnánk megírni a szűrési feltételt, akkor egy <code>BsonDocument</code>-ben kellene ezt a dokumentumot összeállítanunk. A szűrési feltételt leíró dokumentum kulcsai a szűréshez használt mezők, az érték pedig a szűrési feltétel. A feltétel bizonyos esetekben egy skalár érték, mint a reguláris kifejezés (vagy ha egyenlőségre szűrnénk), más esetekben a feltétel egy beágyazott dokumentum, mint a <code>&lt;</code> feltétel esetén. Ebben az <code>$lt</code> kulcs egy speciális kulcs, azt jelöli, hogy a <em>less than</em> operátorral kell a kiértékelés végezni, és az operátor jobb oldalán a 123.0 érték áll. A reguláris kifejezést a <a href="https://www.w3schools.com/jsref/jsref_obj_regexp.asp">JavaScript RegExp szintaktika</a> szerint kell megadni. Az ilyen módon felsorolt feltételek automatikusan <em>és</em> kapcsolatba kerülnek.</p>
<p>A Lambda-kifejezés helyett egy hasonló leírást magunk is előállíthatunk anélkül, hogy szöveges formában kellene összeállítanunk a szűrési feltételt. A MongoDB .NET drivere lehetőséget ad nekünk arra, hogy egy ún. <strong><em>builder</em></strong> segítségével építsük fel a szűrési feltételt.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span>
    <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">And</span><span class="p">(</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">123</span><span class="p">),</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Regex</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">&quot;/red/s&quot;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<p>A fenti szintaktikai kicsit bőbeszédűbb ugyan, mint a Lambda-kifejezés, de közelebb áll a MongoDB világához, és jobban leírja, mit is szeretnénk valójában. Tekinthetünk erre a szintaktikára úgy, mint az SQL nyelvre: deklaratív, célorientált, de a platform képességeit szem előtt tartó leírás. Emellett azonban típusbiztos is.</p>
<p>A <code>Builders&lt;T&gt;</code> generikus osztály egy segédosztály, amivel szűrési, és később látni fogjuk, egyéb MongoDB specifikus definíciókat építhetünk fel. A <code>Builders&lt;Product&gt;.Filter</code> a <em>Product</em> C# osztályhoz illeszkedő szűrési feltételek definiálására használható. Először egy <em>és</em> kapcsolatot hozunk létre, amelyen belül két szűrési feltételünk lesz. Az operátorok a korábban látott <em>less than</em> és a reguláris kifejezés. Ezen függvényeknek két paramétert adunk át: a mezőt, amire szűrni szeretnénk, és az operandust.</p>
<div class="admonition note">
<p class="admonition-title"><em>Expression</em> szintaktika</p>
<p>Vegyük észre, hogy se itt, se a Lambda-kifejezésekben nem használtunk string alapú mezőneveket, mindenhol ugyanazzal a szintaktikával (ez a <em>C# Expression</em>) az osztálydefinícióra hivatkoztunk. Ez azért praktikus így, mert elkerüljük a mezőnevek elgépelését.</p>
</div>
<p>Valójában mindegyik leírás, amit használtunk, ugyanazt a szűrési feltételt jelenti. A MongoDB driver mindegyik szintaktikát leképezi a saját belső reprezentációjává. A Lambda-kifejezés alapú kevesebb karaktert igényel, és jobban illeszkedik a C# nyelvbe, míg az utóbbi a MongoDB sajátosságainak kifejezésére való. Bármelyiket használhatjuk.</p>
<h3 id="lekerdezes-eredmenyenek-felhasznalasa">Lekérdezés eredményének felhasználása<a class="headerlink" href="#lekerdezes-eredmenyenek-felhasznalasa" title="Permanent link">&para;</a></h3>
<p>A <code>collection.Find(...)</code> függvény eredménye még nem az eredményhalmaz, hanem csak egy leíró a lekérdezés végrehajtásához. Az eredmény általában három féle módon kérhető le és dolgozható fel.</p>
<h4 id="listazas">Listázás<a class="headerlink" href="#listazas" title="Permanent link">&para;</a></h4>
<p>Kérjük a teljes eredményhalmazt egy listaként: <code>collection.Find(...).ToList()</code>.</p>
<h4 id="elsoegyetlen-elem-lekerese">Első/egyetlen elem lekérése<a class="headerlink" href="#elsoegyetlen-elem-lekerese" title="Permanent link">&para;</a></h4>
<p>Amennyiben csak az első elemre van szükségünk, vagy tudjuk, hogy csak egy elem lesz, akkor használhatjuk a <code>collection.Find(...).First()</code>, <code>.FirstOrDefault()</code>, vagy <code>.Single()</code>, <code>.SingleOrDefault()</code> függvényeket.</p>
<h4 id="kurzor">Kurzor<a class="headerlink" href="#kurzor" title="Permanent link">&para;</a></h4>
<p>Ha az eredményhalmaz sok dokumentumot tartalmaz, célszerű kurzorral feldolgozni. A MongoDB limitálja a lekérdezésre adott válasz méretét, ezért ha túl sok dokumentumot kérdezünk le, előfordulhat, hogy az eredmény helyett hibát fogunk kapni. Ennek feloldására használjuk a kurzorokat, ahol mindig csak egy részhalmazát kapjuk a dokumentumoknak.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">cur</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(...).</span><span class="n">ToCursor</span><span class="p">();</span>
<span class="k">while</span> <span class="p">(</span><span class="n">cur</span><span class="p">.</span><span class="n">MoveNext</span><span class="p">())</span> <span class="c1">// kurzor léptetése</span>
<span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">t</span> <span class="k">in</span> <span class="n">cur</span><span class="p">.</span><span class="n">Current</span><span class="p">)</span> <span class="c1">// a kurzor aktuális eleme nem egy dokumentum, hanem egy lista</span>
    <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="szureshez-hasznalhato-operatorok">Szűréshez használható operátorok<a class="headerlink" href="#szureshez-hasznalhato-operatorok" title="Permanent link">&para;</a></h3>
<p>A szűrési feltételek a dokumentumban található mezőkre vonatkoznak, és a szűrési feltétel mindig egy konstans. Tehát <strong>nem lehetséges például két mezőt összehasonlítani</strong>, és nem tudunk más gyűjteményekre se hivatkozni. Létezik a MongoDB-ben egy ún. aggregációs pipeline, amely segítségével bonyolultabb lekérdezéseket is megfogalmazhatunk, most viszont az egyszerű lekérdezésekre koncentrálunk.</p>
<p>A szűrési feltétel tehát a dokumentum egy mezőjét egy általunk megadott konstanshoz hasonlítja. Az alábbi lehetőségek a leggyakrabban használtak.</p>
<h4 id="osszehasonlitasi-operatorok">Összehasonlítási operátorok<a class="headerlink" href="#osszehasonlitasi-operatorok" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">==</span> <span class="m">123</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Eq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">123</span><span class="p">));</span> <span class="c1">//Eq, mint equals</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">!=</span> <span class="m">123</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Ne</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">123</span><span class="p">));</span> <span class="c1">// Ne, mint not equals</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&gt;=</span> <span class="m">123</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Gte</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">123</span><span class="p">));</span> <span class="c1">// Gte, mint greater than or equal to</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">123</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">123</span><span class="p">));</span> <span class="c1">// Lt, mint less than</span>
</code></pre></div>
<h4 id="logikai-operatorok">Logikai operátorok<a class="headerlink" href="#logikai-operatorok" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&gt;</span> <span class="m">500</span> <span class="p">&amp;&amp;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">1000</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span>
    <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">And</span><span class="p">(</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Gt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">500</span><span class="p">),</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">1000</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">500</span> <span class="p">||</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span>
    <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Or</span><span class="p">(</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">500</span><span class="p">),</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="p">!(</span><span class="n">x</span><span class="p">.</span><span class="n">Price</span> <span class="p">&lt;</span> <span class="m">500</span> <span class="p">||</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">));</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span>
    <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Not</span><span class="p">(</span>
        <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Or</span><span class="p">(</span>
            <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">500</span><span class="p">),</span>
            <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<h4 id="tobb-ertek-kozul-valamelyikkel-megegyezo">Több érték közül valamelyikkel megegyező<a class="headerlink" href="#tobb-ertek-kozul-valamelyikkel-megegyezo" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="p">...</span> <span class="p">||</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">=</span> <span class="p">...);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">In</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}));</span>
<span class="c1">// hasonlóan létezik a Nin, mint not in operátor</span>
</code></pre></div>
<h4 id="ertek-letezik-nem-null">Érték létezik (nem null)<a class="headerlink" href="#ertek-letezik-nem-null" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span><span class="p">));</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Létezik-e</p>
<p>A létezik-e, azaz nem null szűrés azért különleges, mert a MongoDB szempontjából két módon is lehet null egy érték: ha a kulcs létezik a dokumentumban és értéke null; avagy, ha a kulcs nem is létezik.</p>
</div>
<h3 id="szures-beagyazott-dokumentum-mezojere">Szűrés beágyazott dokumentum mezőjére<a class="headerlink" href="#szures-beagyazott-dokumentum-mezojere" title="Permanent link">&para;</a></h3>
<p>A MongoDB szempontjából a beágyazott dokumentumok ugyanúgy használhatók szűrésre, tehát az alábbiak mind érvényesek, és az se okoz gondot, ha a beágyazott dokumentum (a példákban a <em>VAT</em> nem létezik):</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span> <span class="p">&lt;</span> <span class="m">27</span><span class="p">);</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Lt</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span><span class="p">,</span> <span class="m">27</span><span class="p">));</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span><span class="p">,</span> <span class="n">exists</span><span class="p">:</span> <span class="k">false</span><span class="p">));</span>
<span class="c1">// ez a nem létezik, azaz null szűrés</span>
</code></pre></div>
<h3 id="szures-tomb-erteku-mezore">Szűrés tömb értékű mezőre<a class="headerlink" href="#szures-tomb-erteku-mezore" title="Permanent link">&para;</a></h3>
<p>A dokumentum bármely mezője lehet tömb értékű, mint a példában a <code>string[] Categories</code>. MongoDB-ben a tömbökkel is egyszerűen tudunk dolgozni, az <code>Any*</code> szűrési feltételekkel.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// azon termékeket, amelyek a jelzett kategóriában vannak</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyEq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;Labdák&quot;</span><span class="p">));</span>

<span class="c1">// azon termékeket, amelyek legalább egy olyan kategóriához tartoznak, amelyet nem soroltunk fel</span>
<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyNin</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;Labdák&quot;</span><span class="p">,</span> <span class="s">&quot;Ütők&quot;</span> <span class="p">}));</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Any...</p>
<p>Az <code>Any*</code> feltételek a tömb minden elemét vizsgálják, de a dokumentum szempontjából csak egyszer illeszkednek. Tehát, ha a tömb több eleme is illeszkedik egy feltételre, attól még csak egyszer kapjuk meg a dokumentumot az eredményhalmazban.</p>
</div>
<h2 id="lekerdezes-vegrehajto-pipeline">Lekérdezés-végrehajtó pipeline<a class="headerlink" href="#lekerdezes-vegrehajto-pipeline" title="Permanent link">&para;</a></h2>
<p>A MongoDB lekérdezések egy ún. pipeline-on haladnak végig. Ennek részleteivel nem fogunk megismerkedni, de az egyszerű szűréseken kívül pár további, lekérdezésekben használt elemet fogunk látni.</p>
<h4 id="lapozas-rendezes">Lapozás, rendezés<a class="headerlink" href="#lapozas-rendezes" title="Permanent link">&para;</a></h4>
<p>A lapozáshoz megadhatjuk, maximálisan hány illeszkedő dokumentumot kérünk:</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(...).</span><span class="n">Limit</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</code></pre></div>
<p>A következő lapon található elemekhez pedig kihagyjuk az első lapon már látott elemeket:</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(...).</span><span class="n">Skip</span><span class="p">(</span><span class="m">100</span><span class="p">).</span><span class="n">Limit</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</code></pre></div>
<p>A <code>Skip</code> és <code>Limit</code> ebben a formában nem értelmes, ugyanis rendezés nélkül az "első 100 elem" lekérdezés (a kliens számára) nem determinisztikus. Tehát az ilyen jellegű lekérdezésekhez szükséges, hogy egy megfelelő rendezést is megadjunk. A rendezés definiálása a korábban már látott <code>Builders&lt;T&gt;</code> segítségével történik.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(...)</span>
    <span class="p">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Sort</span><span class="p">.</span><span class="n">Ascending</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span><span class="p">))</span>
    <span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">100</span><span class="p">).</span><span class="n">Limit</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">Lapozási probléma</p>
<p>A fenti lapozás még mindig nem teljesen helyes. Például, ha a két lap lekérdezése közben egy termék törlésre kerül, akkor "eggyel arrébb csúsznak" a termékek, és lesz egy termék, amely kimarad a következő lapozásnál. Ez nem csak a MongoDB problémája. Gondolkodtató feladat: hogyan oldható meg ez a probléma?</p>
</div>
<h4 id="darabszam-lekerdezes">Darabszám lekérdezés<a class="headerlink" href="#darabszam-lekerdezes" title="Permanent link">&para;</a></h4>
<p>A lekérdezésre illeszkedő dokumentumok számát kétféle módon is lekérdezhetjük:</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">CountDocuments</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyEq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;Labdák&quot;</span><span class="p">));</span>

<span class="n">collection</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyEq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;Labdák&quot;</span><span class="p">)).</span><span class="n">CountDocuments</span><span class="p">();</span>
</code></pre></div>
<h4 id="aggregacios-pipeline">Aggregációs pipeline<a class="headerlink" href="#aggregacios-pipeline" title="Permanent link">&para;</a></h4>
<p>Az aggregációs műveletek több dokumentumot dolgoznak fel és azokból valamilyen számítással előállított eredményt adnak vissza. A MongoDB három módot biztosít számunkra ilyen összesítő műveletek elvégzéséhez:</p>
<ul>
<li>Aggregációs pipelineok</li>
<li>Egycélú aggregációs műveletek (Single Purpose Aggregation Operations)</li>
<li>Map-reduce függvények</li>
</ul>
<p>A MongoDB 5.0 verziója óta a <strong>Map-reduce</strong> elavult módszernek számít, mivel az aggregációs pipeline használhatóság és sebesség szempontjából is kedvezőbb nála.</p>
<p>Az egycélú aggregációs műveletek (<strong>Single Purpose Aggregation Operations</strong>) terén a MongoDB biztosítja számunkra a <code>IMongoCollection&lt;TDocument&gt;.EstimatedDocumentCount()</code>, <code>IMongoCollection&lt;TDocument&gt;.Count()</code> és <code>IMongoCollection&lt;TDocument&gt;.Distinct()</code> függvényeket, melyeknek közös jellemzőjük, hogy mindegyik egy darab gyűjteményen végez műveletet.</p>
<p><img alt="Single Purpose Aggregation Operation" src="images/mongodb_spao.svg" /></p>
<div class="admonition cite">
<p class="admonition-title">Forrás</p>
<p><a href="https://docs.mongodb.com/manual/images/distinct.bakedsvg.svg">https://docs.mongodb.com/manual/images/distinct.bakedsvg.svg</a></p>
</div>
<p>Az általános aggregációkhoz pedig készíthetünk pipeline-okat. Egy <strong>aggregációs pipeline</strong> több stage-ből épül fel, mindegyik valamilyen műveletet <em>(filter, group, count, calculate stb.)</em> végez a bemeneti dokumentumain. Egy pipeline képes több eredményt is visszaadni egy dokumentumhalmazról <em>(pl. total, average, maximum vagy minimum értékeket)</em>.</p>
<p>Nézzük ezt a csoportosítás példáján keresztül.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// A &quot;Labdák&quot; kategóriába tartozó termékek az ÁFA kulcs szerint csoportosítva</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">g</span> <span class="k">in</span> <span class="n">collection</span><span class="p">.</span><span class="n">Aggregate</span><span class="p">()</span>
                            <span class="p">.</span><span class="n">Match</span><span class="p">(</span><span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyEq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;Labdák&quot;</span><span class="p">))</span> <span class="c1">// szűrés</span>
                            <span class="p">.</span><span class="n">Group</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span><span class="p">,</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="c1">// csoportosítás</span>
                            <span class="p">.</span><span class="n">ToList</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&quot;VAT percentage: {g.Key}&quot;</span><span class="p">);</span>
    <span class="k">foreach</span><span class="p">(</span><span class="kt">var</span> <span class="n">p</span> <span class="k">in</span> <span class="n">g</span><span class="p">)</span>
        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&quot;\tProduct: {p.Name}&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="beszuras-modositas-torles">Beszúrás, módosítás, törlés<a class="headerlink" href="#beszuras-modositas-torles" title="Permanent link">&para;</a></h2>
<p>A lekérdezések után ismerkedjünk meg az adatmódosításokkal.</p>
<h3 id="uj-dokumentum-beszurasa">Új dokumentum beszúrása<a class="headerlink" href="#uj-dokumentum-beszurasa" title="Permanent link">&para;</a></h3>
<p>Új dokumentum beszúrásához az új dokumentumot reprezentáló objektumra van szükségünk. Ezt a gyűjteményhez tudjuk hozzáadni.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">newProduct</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Product</span>
<span class="p">{</span>
    <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Alma&quot;</span><span class="p">,</span>
    <span class="n">Price</span> <span class="p">=</span> <span class="m">890</span><span class="p">,</span>
    <span class="n">Categories</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;Gyümölcsök&quot;</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">collection</span><span class="p">.</span><span class="n">InsertOne</span><span class="p">(</span><span class="n">newProduct</span><span class="p">);</span>

<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&quot;Beszúrt rekord id: {newProduct.Id}&quot;</span><span class="p">);</span> <span class="c1">// beszúrás után frissítésre kerül a C# objektum, és lekérdezhető az Id-ja</span>
</code></pre></div>
<p>Figyeljük meg, hogy az <code>Id</code> mezőt nem töltöttük ki. Ezt a kliens oldali driver pótolni fogja. Ha akarjuk, mi is adhatunk neki értéket, de nem szokás.</p>
<p>Emlékezzünk rá, hogy a MongoDB-ben nincs séma, így a beszúrt dokumentum lehet teljesen eltérő a gyűjteményben található többi elemtől. Illetve figyeljük meg, hogy nem adtunk minden mezőnek értéket. Mivel nincsenek integritási kritériumok, így minden beszúrás sikerrel fog járni, viszont a lekérdezésnél lehetnek belőle problémák (pl. ha feltételezzük, hogy a raktárkészlet mindig ki van töltve).</p>
<p>Több dokumentum beszúrására az <code>InsertMany</code> függvény használható, azonban ne felejtkezzünk el arról, hogy alapértelmezetten nincsenek tranzakciók, így a több dokumentum beszúrása egyenként független művelet. Ha a beszúrások végrehajtása közben valamely okból hiba történik, az addig sikeresen beszúrt dokumentumok az adatbázisban maradnak. Az egyes dokumentumok azonban atomi módon kerülnek mentésre, tehát egy hiba során se kerülhet egy "fél" dokumentum az adatbázisba.</p>
<h3 id="dokumentumok-torlese">Dokumentumok törlése<a class="headerlink" href="#dokumentumok-torlese" title="Permanent link">&para;</a></h3>
<p>A törléshez egy szűrési feltételt kell definiálnunk, és vagy a <code>DeleteOne</code>, vagy a <code>DeleteMany</code> függvénnyel törölhetünk. A különbség, hogy a <code>DeleteOne</code> az <em>első</em> illeszkedő dokumentumot törli csak, míg a <code>DeleteMany</code> az összeset. Ha tudjuk, hogy a feltételnek csak egy dokumentum felelhet meg (például id alapján törlünk), akkor érdemes a <code>DeleteOne</code>-t használni, mert az adatbázisnak nem kell kimerítő keresést végeznie.</p>
<p>A törlés feltétele a keresésnél megismert szintaktikákkal írható le.</p>
<div class="admonition note">
<p>A törlés tehát eltér az Entity Framework esetén tapasztalható viselkedésről. Itt nem kell az entitásnak betöltve lennie, és nem az entitást töröljük, hanem szűrési feltétellel írjuk le a törlést.</p>
</div>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">deleteResult</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">DeleteOne</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">));</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&quot;Törölve: {deleteResult.DeletedCount} db&quot;</span><span class="p">);</span>
</code></pre></div>
<p>Ha szeretnénk a törölt elemet megkapni, akkor használhatjuk a <code>FindOneAndDelete</code>-t, amely visszaadja a törölt entitást magát.</p>
<h3 id="dokumentumok-megvaltoztatasa">Dokumentumok megváltoztatása<a class="headerlink" href="#dokumentumok-megvaltoztatasa" title="Permanent link">&para;</a></h3>
<p>A MongoDB talán legérdekesebb képességei a dokumentumok megváltoztatása körül találhatóak. Míg a korábbiak, a lekérdezések, beszúrások, törlések a legtöbb adatbázis (akár relációs, akár NoSQL) esetén hasonlóak, a MongoDB a módosító műveletekben jóval szélesebb spektrumot támogat.</p>
<p>Alapvetően két féle módon tudunk egy dokumentumot megváltoztatni: lecserélni az egész dokumentumot egy újra, avagy részeit frissíteni.</p>
<h4 id="dokumentum-teljes-csereje">Dokumentum teljes cseréje<a class="headerlink" href="#dokumentum-teljes-csereje" title="Permanent link">&para;</a></h4>
<p>A dokumentum teljes cseréjéhez szükségünk van egy szűrési feltételre, amellyel megadjuk, mely dokumentumot akarjuk cserélni; valamint szükségünk van az új dokumentumra.</p>
<div class="highlight"><pre><span></span><code><span class="kt">var</span> <span class="n">replacementProduct</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Product</span>
<span class="p">{</span>
    <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Alma&quot;</span><span class="p">,</span>
    <span class="n">Price</span> <span class="p">=</span> <span class="m">890</span><span class="p">,</span>
    <span class="n">Categories</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;Gyümölcsök&quot;</span> <span class="p">}</span>
<span class="p">};</span>
<span class="kt">var</span> <span class="n">replaceResult</span> <span class="p">=</span> <span class="n">collection</span><span class="p">.</span><span class="n">ReplaceOne</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">),</span> <span class="n">replacementProduct</span><span class="p">);</span>
<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&quot;Módosítva: {replaceResult.ModifiedCount}&quot;</span><span class="p">);</span>
</code></pre></div>
<p>Ez a csere 1-1 jellegű, azaz egy dokumentumot cserélünk egy dokumentumra. A művelet magában atomi, azaz ha menet közben megszakad, akkor se fordulhat elő, hogy egy fél dokumentum került elmentésre. Ha szeretnénk megkapni a csere előtti dokumentumot, akkor a <code>FindOneAndReplace</code> metódust használhatjuk.</p>
<div class="admonition note">
<p class="admonition-title">Érdekesség</p>
<p>A csere során lehetőség van a dokumentum id-jának módosítására is. Ha a csere dokumentumban más id szerepel, a dokumentum id-ja megváltozik.</p>
</div>
<h4 id="dokumentum-modosito-operatorok">Dokumentum módosító operátorok<a class="headerlink" href="#dokumentum-modosito-operatorok" title="Permanent link">&para;</a></h4>
<p>A dokumentum módosító operátorokkal atomi módon tudunk a dokumentum mezőinek értékén változtatni anélkül, hogy a teljes dokumentumot lecserélnénk. A módosító műveletek leírásához a korábban már látott <code>Builders&lt;T&gt;</code> segítségét vesszük igénybe.</p>
<p>Állítsunk be a raktárkészletet egy konstans értékre:</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">UpdateOne</span><span class="p">(</span>
    <span class="n">filter</span><span class="p">:</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">),</span>
    <span class="n">update</span><span class="p">:</span> <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Update</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span> <span class="m">5</span><span class="p">));</span>
</code></pre></div>
<p>Az <code>UpdateOne</code> függvény első paramétere a szűrési feltétel. Leírásához bármely korábban ismertetett szintaktika használható. Második paramétere a módosító művelet leírója, amelyet a <code>Builders&lt;T&gt;</code> segítségével építhetünk fel.</p>
<p>A fenti példakódban a paraméterek nevét is kiírtuk (<code>filter:</code> és <code>update:</code>), hogy egyértelmű legyen, paraméter mit jelképez. Ez nem kötelező, de az olvashatóságot növeli (a kódsorok hosszának rovására).</p>
<p>A módosítás nem csak egy műveletet tartalmazhat.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">UpdateOne</span><span class="p">(</span>
    <span class="n">filter</span><span class="p">:</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">),</span>
    <span class="n">update</span><span class="p">:</span> <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Update</span>
                <span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span> <span class="c1">// raktárkészlet legyen 5</span>
                <span class="p">.</span><span class="n">CurrentDate</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">StockUpdated</span><span class="p">)</span> <span class="c1">// mai dátumot beírjuk, mint a frissítés ideje</span>
                <span class="p">.</span><span class="n">Unset</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">NeedsUpdate</span><span class="p">)</span> <span class="c1">// töröljük a frissítendő jelzést</span>
<span class="p">);</span>
</code></pre></div>
<p>A tipikusan használt módosító operátorok:</p>
<ul>
<li><code>Set</code>: mező értékének beállítása;</li>
<li><code>SetOnInsert</code>: mint a <code>Set</code>, de csak új dokumentum beszúrása esetén fut le (lásd <em>upsert</em> alább);</li>
<li><code>Unset</code>: mező törlése (a kulcs és érték eltávolítása a dokumentumból);</li>
<li><code>CurrentDate</code>: aktuális dátum beírása;</li>
<li><code>Inc</code>: érték növelése;</li>
<li><code>Min</code>, <code>Max</code>: mező értékének lecserélése, amennyiben a megadott érték kisebb/nagyobb, mint a mező jelenlegi értéke;</li>
<li><code>Mul</code>: érték megszorzása;</li>
<li><code>PopFirst</code>, <code>PopLast</code>: tömbből első/utolsó elem eltávolítása;</li>
<li><code>Pull</code>: tömbből érték eltávolítása;</li>
<li><code>Push</code>: tömbhöz érték hozzáadása a végére (további lehetőségek ugyanebben az operátorban: tömb sorrendezése, tömb első <em>n</em> elemének megtartása);</li>
<li><code>AddToSet</code>: tömbhöz érték hozzáadása, ha még nem létezik.</li>
</ul>
<p>A fenti műveletek akkor is értelmezettek, ha a megadott mező nem létezik. Az operátor típusától függően egy alapértelmezett értéken végzi a módosítást az adatbázis. Például az <code>Inc</code> és <code>Mul</code> esetén a mező 0 értéket vesz fel, és azon történik a módosítás. A tömb műveletek esetén egy üres tömb kerül módosításra. A többi művelet esetén <a href="https://docs.mongodb.com/manual/reference/operator/update/">dokumentációból</a> kikereshető a viselkedés.</p>
<p>A fent látott módszerrel nem csak egyetlen dokumentum módosítható. A kért szerkesztő művelet több, a szűrési feltételre illeszkedő dokumentumon is elvégezhető.</p>
<p>Például: a nyári szezonra való tekintettel <em>minden</em> labdára adjunk 25% engedményt, és adjuk őket hozzá az akciós kategóriához.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">UpdateMany</span><span class="p">(</span>
    <span class="n">filter</span><span class="p">:</span> <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Filter</span><span class="p">.</span><span class="n">AnyEq</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;Labdák&quot;</span><span class="p">),</span>
    <span class="n">update</span><span class="p">:</span> <span class="n">Builders</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;.</span><span class="n">Update</span><span class="p">.</span><span class="n">Mul</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span> <span class="m">0.75</span><span class="p">)</span>
                                   <span class="p">.</span><span class="n">AddToSet</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Categories</span><span class="p">,</span> <span class="s">&quot;Akciós termékek&quot;</span><span class="p">));</span>
</code></pre></div>
<p>A módosító operátorok atomi módon teszik szerkeszthetővé a dokumentumainkat. Használatukkal kiküszöbölhető a konkurens adathozzáférésből eredő problémák egy része.</p>
<h4 id="upsert-beszuras-vagy-modositas"><em>Upsert</em>: beszúrás vagy módosítás<a class="headerlink" href="#upsert-beszuras-vagy-modositas" title="Permanent link">&para;</a></h4>
<p>Módosító művelet során lehetőségünk van az ún. <em>upsert (update/insert)</em> jellegű működésre. Ez azt jelenti, hogy vagy beszúrás, vagy módosítás történik, annak függvényében, hogy megtalálható volt-e az elem az adatbázisban. Az alapvető viselkedés <em>nem</em> upsert, azt külön kérnünk kell.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">ReplaceOne</span><span class="p">(</span>
    <span class="n">filter</span><span class="p">:</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="k">new</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">),</span>
    <span class="n">replacement</span><span class="p">:</span> <span class="n">replacementObject</span><span class="p">,</span>
    <span class="n">options</span><span class="p">:</span> <span class="k">new</span> <span class="n">UpdateOptions</span><span class="p">()</span> <span class="p">{</span> <span class="n">IsUpsert</span> <span class="p">=</span> <span class="k">true</span> <span class="p">});</span>
</code></pre></div>
<p>Nem csak a teljes dokumentum cseréje esetén van lehetőségünk upsert-re. A dokumentum módosító operátorokkal is elvégezhetjük ugyanezt. Ahogy láthattuk, a módosító operátorokat nem zavarja, ha nem létezik egy mező. Ugyanígy nem okoz gondot, ha nem létezik a dokumentum; ez azzal egyenértékű, mintha egy teljesen üres dokumentumon végeznénk el a módosító műveleteket.</p>
<div class="highlight"><pre><span></span><code><span class="n">collection</span><span class="p">.</span><span class="n">UpdateOne</span><span class="p">(</span><span class="n">filter</span><span class="p">:</span> <span class="p">...,</span> <span class="n">update</span><span class="p">:</span> <span class="p">...,</span> <span class="n">options</span><span class="p">:</span> <span class="k">new</span> <span class="n">UpdateOptions</span><span class="p">()</span> <span class="p">{</span> <span class="n">IsUpsert</span> <span class="p">=</span> <span class="k">true</span> <span class="p">});</span>
</code></pre></div>
<p>Az upsert művelet egy eszköz a konkurens módosítások terén a tranzakció hiányára. Mivel alapértelmezetten nincs tranzakciónk, ezért nem tudunk meggyőződni arról a beszúrás előtt, hogy még nem létezik egy adott rekord. Helyette használhatjuk az upsert módszert, ami atomi lekérdezést és beszúrást/módosítást tesz lehetővé.</p>
<div class="admonition note">
<p class="admonition-title"><code>merge</code></p>
<p>SQL nyelvben a <code>merge</code> parancs nyújt erre hasonló megoldást.</p>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Élőláb">
      
        
        <a href="../ef/" class="md-footer__link md-footer__link--prev" aria-label="Előző: Kapcsolatok definiálása Entity Framework-ben" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Előző
              </span>
              Kapcsolatok definiálása Entity Framework-ben
            </div>
          </div>
        </a>
      
      
        
        <a href="../di/" class="md-footer__link md-footer__link--next" aria-label="Következő: Függőséginjektálás ASP.NET Core környezetben" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Következő
              </span>
              Függőséginjektálás ASP.NET Core környezetben
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; BME VIK AUT
          </div>
        
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.instant", "navigation.top", "search.suggest"], "translations": {"clipboard.copy": "M\u00e1sol\u00e1s v\u00e1g\u00f3lapra", "clipboard.copied": "V\u00e1g\u00f3lapra m\u00e1solva", "search.config.lang": "hu", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Keres\u00e9s", "search.result.placeholder": "Keres\u00e9shez \u00edrj ide valamit", "search.result.none": "Nincs tal\u00e1lat", "search.result.one": "1 egyez\u0151 dokumentum", "search.result.other": "# egyez\u0151 dokumentum", "search.result.more.one": "1 tov\u00e1bbi tal\u00e1lat az oldalon", "search.result.more.other": "# tov\u00e1bbi tal\u00e1lat az oldalon", "search.result.term.missing": "\u00dcres", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.b1047164.min.js"></script>
      
    
  </body>
</html>